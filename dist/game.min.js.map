{"version":3,"sources":["game.concat.js"],"names":["GameBoard","[object Object]","game","span","gravity","gravityEnabled","this","playerColours","rotationValue","tiltValue","perspectiveX","perspectiveY","boardElement","document","createElement","id","style","marginTop","perspectiveOrigin","b","board","tileSize","className","gridTemplateColumns","repeat","gridTemplateRows","transform","flatArrowsContainer","r","c","tile","addEventListener","makeMove","playerIndex","styleHoverPreview","appendChild","gameState","elem","children","innerHTML","color","row","col","player","querySelectorAll","forEach","classList","toggle","axis","Array","from","GameLogic","players","isTraining","isMultiplayer","aiOpponent","parseInt","numPlayers","resetGame","modifier","directions","up","down","left","right","forward","backward","modifiers","playerNum","push","GamePlayer","epsilon","alpha","gamma","p","boardGameState","rowGameState","resetBoard","winsDisplay","display","console","log","reward","type","applyGravityToMove","addPoint","winningMove","pi","isFull","length","pickMove","epochs","totalEpochs","Math","random","Object","keys","q","boardIndex","tileY","tileX","match","max","mid","floor","every","ri","bi","counts","i","direction","abs","i2","everyBoard","everyColumn","render","checkAll","lastState","JSON","parse","stringify","lastMove","undefined","state","action","key","join","replace","moves","Number","isNaN","getAvailableMoves","index","qs","m","getQ","maxQ","slice","sort","reverse","indexOf","value","prev","aMoves","maxqNew","a"],"mappings":"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","file":"game.min.js","sourcesContent":["\"use strict\"\r\n\r\nclass GameBoard {// eslint-disable-line\r\n\r\n    constructor (game) {\r\n\r\n        const {span, gravity, gravityEnabled} = game\r\n\r\n        this.playerColours = [\"blue\", \"red\", \"green\", \"purple\", \"yellow\", \"brown\", \"black\", \"cyan\", \"pink\", \"darkgrey\"]\r\n        this.rotationValue = -45\r\n        this.tiltValue = span==3 ? 20 : span==7 ? 40 : 30\r\n        this.span = span\r\n        this.gravity = gravity\r\n        this.gravityEnabled = gravityEnabled\r\n        this.perspectiveX = 150\r\n        this.perspectiveY = 1000\r\n        this.boardElement = document.createElement(\"div\")\r\n        this.boardElement.id = \"boardsContainer\"\r\n\r\n        if (this.span!=3) {\r\n            this.boardElement.style.marginTop = \"0\"\r\n\r\n            if (this.span==7) {\r\n                this.boardElement.style.marginTop = \"100px\"\r\n                this.perspectiveY = 800\r\n            } else {\r\n                this.perspectiveY = 1000\r\n            }\r\n        }\r\n\r\n        this.boardElement.style.perspectiveOrigin = `${this.perspectiveX}px ${this.perspectiveY}px`\r\n\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n\r\n            const board = document.createElement(\"div\")\r\n            const tileSize = 300/this.span\r\n\r\n            board.className = \"board\"\r\n            board.style.gridTemplateColumns = `${tileSize}px `.repeat(this.span)\r\n            board.style.gridTemplateRows = `${tileSize}px `.repeat(this.span)\r\n            board.style.transform = `rotateX(${this.tiltValue}deg) rotateZ(${this.rotationValue}deg)`\r\n            board.style.marginTop = this.span==7 ? \"-70%\" : \"-50%\"\r\n\r\n            // TODO, move this out of here\r\n            flatArrowsContainer.style.transform = `rotateX(${this.tiltValue+30}deg) rotateZ(${this.rotationValue-45}deg)`\r\n\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    const tile = document.createElement(\"div\")\r\n\r\n                    tile.addEventListener(\"click\", () => game.makeMove(game.playerIndex, b, r, c))\r\n                    tile.addEventListener(\"mouseover\", () => this.styleHoverPreview(b, r, c))\r\n\r\n                    board.appendChild(tile)\r\n                }\r\n            }\r\n\r\n            this.boardElement.appendChild(board)\r\n        }\r\n\r\n    }\r\n\r\n    render (gameState) {\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n\r\n                    const elem = this.boardElement.children[b].children[r*this.span + c]\r\n\r\n                    if (gameState[b][r][c] === \" \") {\r\n                        elem.innerHTML = \"\"\r\n                    } else {\r\n                        elem.innerHTML = \"•\"\r\n                        elem.style.color = this.playerColours[gameState[b][r][c]]\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    addPoint (board, row, col, player) {\r\n        this.boardElement.children[board].children[row*this.span + col].innerHTML = \"•\"\r\n        this.boardElement.children[board].children[row*this.span + col].style.color = this.playerColours[player]\r\n    }\r\n\r\n    renderPoints () {\r\n\r\n    }\r\n\r\n    resetBoard () {\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    this.boardElement.children[b].children[r*this.span + c].innerHTML = \"\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Highlight the column/row/vertical-column that will be affected by a move\r\n    styleHoverPreview (board, row, col) {\r\n\r\n        if (!this.gravityEnabled) {\r\n            return\r\n        }\r\n\r\n        // Clear last highlighted tiles\r\n        const existingHovered = this.boardElement.querySelectorAll(\".hoveredTile\")\r\n        existingHovered.forEach(tile => tile.classList.toggle(\"hoveredTile\"))\r\n\r\n        switch (this.gravity.axis) {\r\n            // Up/Down\r\n            case 0:\r\n                for (let b=0; b<this.span; b++) {\r\n                    this.boardElement.children[b].children[row*this.span + col].classList.toggle(\"hoveredTile\")\r\n                }\r\n                break\r\n            // Left/Right\r\n            case 1:\r\n                for (let c=0; c<this.span; c++) {\r\n                    this.boardElement.children[board].children[row*this.span + c].classList.toggle(\"hoveredTile\")\r\n                }\r\n                break\r\n            // Forward/Backward\r\n            case 2:\r\n                for (let r=0; r<this.span; r++) {\r\n                    this.boardElement.children[board].children[r*this.span + col].classList.toggle(\"hoveredTile\")\r\n                }\r\n                break\r\n        }\r\n\r\n    }\r\n\r\n\r\n    rotate () {\r\n        Array.from(this.boardElement.children).forEach(board => {\r\n            board.style.transform = `rotateX(${this.tiltValue}deg) rotateZ(${this.rotationValue}deg)`\r\n            flatArrowsContainer.style.transform = `rotateX(${this.tiltValue+30}deg) rotateZ(${this.rotationValue-45}deg)`\r\n        })\r\n    }\r\n\r\n}\r\n\"use strict\"\r\n\r\nclass GameLogic {// eslint-disable-line\r\n\r\n    constructor ({gameState, gravityEnabled=true, span=3, players=2, isTraining, isMultiplayer, aiOpponent}={}) {\r\n\r\n        this.players = []\r\n        this.gravityEnabled = gravityEnabled\r\n        this.span = parseInt(span)\r\n        this.numPlayers = parseInt(players)\r\n        this.isTraining = isTraining // AI\r\n        this.aiOpponent = aiOpponent // AI\r\n        this.isMultiplayer = isMultiplayer // TODO, will be used to disallow moves until a move is made via WebSocket\r\n\r\n        this.gameState = gameState || this.resetGame() // Allow accepting an existing game state to allow loading existing match\r\n        this.gravity = {\r\n            axis: 0, // 0 for up/down, 1 for left/right, 2 for  forward/backward\r\n            modifier: -1 // -1 for normal, 1 for reverse\r\n        }\r\n        this.directions = {\r\n            up: 0,\r\n            down: 0,\r\n            left: 1,\r\n            right: 1,\r\n            forward: 2,\r\n            backward: 2\r\n        }\r\n        this.modifiers = {\r\n            up: 1,\r\n            down: -1,\r\n            left: -1,\r\n            right: 1,\r\n            forward: -1,\r\n            backward: 1\r\n        }\r\n\r\n        this.board = new GameBoard(this)\r\n        playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n\r\n\r\n        // Set the first player to either AI or human (aka the actual player)\r\n        if (this.aiOpponent) {\r\n            this.players.push(new GamePlayer(\"AI\", 0, this, {epsilon, alpha, gamma}))\r\n        } else {\r\n            this.players.push(new GamePlayer(\"local human\", 0))\r\n        }\r\n\r\n        // Set the rest to whatever was configured\r\n        for (let p=1; p<players; p++) {\r\n\r\n            // TODO, disallow more than 1 other player when playing against AI - model needed would be too big\r\n            if (this.isTraining) {\r\n                this.players.push(new GamePlayer(\"AI\", p, this, {epsilon, alpha, gamma}))\r\n            } else if (isMultiplayer) {\r\n                this.players.push(new GamePlayer(\"remote human\", p))\r\n            } else {\r\n                this.players.push(new GamePlayer(\"local human\", p))\r\n            }\r\n        }\r\n\r\n        // Randomize who starts\r\n        this.playerIndex = 0//Math.floor(Math.random()*players)\r\n\r\n    }\r\n\r\n    // Create the board brand new\r\n    resetGame () {\r\n\r\n        const gameState = []\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n\r\n            const boardGameState = []\r\n\r\n            for (let r=0; r<this.span; r++) {\r\n\r\n                const rowGameState = []\r\n\r\n                for (let c=0; c<this.span; c++) {\r\n                    rowGameState.push(\" \")\r\n                }\r\n\r\n                boardGameState.push(rowGameState)\r\n            }\r\n            gameState.push(boardGameState)\r\n        }\r\n\r\n        if (this.board) {\r\n            this.board.resetBoard()\r\n            playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        }\r\n\r\n        winsDisplay.style.display = \"none\"\r\n        this.gameState = gameState\r\n        return gameState\r\n    }\r\n\r\n    makeMove (p, b, r, c) {\r\n\r\n        if (p != this.playerIndex && !this.isTraining) {\r\n            console.log(\"NOT your turn!\")\r\n            return\r\n        }\r\n\r\n        // Illegal move\r\n        if (this.gameState[b][r][c] !== \" \") {\r\n            console.log(\"Illegal move\")\r\n\r\n            // Slap its hands, if it was an AI player\r\n            this.players[p].reward(-99, this.gameState)\r\n\r\n            // Stop the game if it's an AI, to avoid looping to stack overflow\r\n            if (this.players[p].type==\"AI\") {\r\n                this.resetGame()\r\n            }\r\n\r\n            return\r\n        }\r\n\r\n        [b, r, c] = this.applyGravityToMove(b, r, c)\r\n\r\n        this.gameState[b][r][c] = p\r\n        this.board.addPoint(b, r, c, p)\r\n\r\n        // Player wins\r\n        if (this.winningMove(b, r, c, p)) {\r\n            console.log(\"Player wins\", p)\r\n            this.players[p].reward(1, this.gameState)\r\n            this.players.forEach((player, pi) => pi!=p && player.reward(-1, this.gameState))\r\n            winsDisplay.style.display = \"inline-block\"\r\n            return\r\n        }\r\n\r\n        // Tied game\r\n        if (this.isFull()) {\r\n            console.log(\"Tied game\")\r\n            this.players.forEach(player => player.reward(0.25, this.gameState))\r\n            return\r\n        }\r\n\r\n\r\n        // TODO, this might be useless - TEST\r\n        this.players.forEach((player, pi) => pi!=p && player.reward(0, this.gameState))\r\n\r\n        this.playerIndex = ++this.playerIndex % this.players.length\r\n\r\n        // TODO, do this outside of this class?\r\n        playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        winsDisplay.style.display = \"none\"\r\n\r\n        this.players[this.playerIndex].pickMove(this.gameState)\r\n    }\r\n\r\n    trainAI ({epsilon, alpha, gamma, epochs=20000}={}) {\r\n\r\n        this.span = 3\r\n        this.players = []\r\n        this.players.push(new GamePlayer(\"AI\", 0, this, {epsilon, alpha, gamma}))\r\n        this.players.push(new GamePlayer(\"AI\", 1, this, {epsilon, alpha, gamma}))\r\n        this.resetGame()\r\n        this.isTraining = true\r\n\r\n        let totalEpochs = 0\r\n\r\n        while (totalEpochs < epochs) {\r\n\r\n            // Randomize who starts, to train both cases\r\n            this.playerIndex = Math.random() < 0.5 ? 1 : 0\r\n\r\n            this.players[this.playerIndex].pickMove(this.gameState)\r\n\r\n            totalEpochs++\r\n            this.resetGame()\r\n        }\r\n\r\n        console.log(\"Training finished\", Object.keys(this.players[0].q).length, Object.keys(this.players[1].q).length)\r\n        this.isTraining = false\r\n        this.players[0] = new GamePlayer(\"local human\", 0)\r\n        this.players[1].epsilon = 0\r\n        this.playerIndex = 0//Math.random() < 0.5 ? 0 : 1\r\n        // this.players[this.playerIndex].pickMove(this.gameState)\r\n    }\r\n\r\n    TEMPReset () {\r\n        this.resetGame()\r\n        this.playerIndex = Math.random() < 0.5 ? 1 : 0\r\n        this.players[this.playerIndex].pickMove(this.gameState)\r\n    }\r\n\r\n    winningMove (boardIndex, tileY, tileX, player) {\r\n\r\n        let match = false\r\n        const max = this.gameState[0].length-1\r\n        const mid = Math.floor(max/2)\r\n\r\n        // Check current board\r\n        match = this.gameState[boardIndex][tileY].every(col => col===player) // Horizontal\r\n            ||  this.gameState[boardIndex].every(row => row[tileX]===player) // Vertical\r\n            ||  (tileX + tileY)%2 === 0 && ( // Is it on a diagonal?\r\n                // Diagonal top-left -> bottom-right\r\n                this.gameState[boardIndex].every((row, ri) => row[ri]===player) ||\r\n                // Diagonal bottom-left -> top-right\r\n                this.gameState[boardIndex].every((row, ri) => row[max-ri]===player)\r\n            )\r\n\r\n        // Check other boards\r\n        // Up/Down\r\n        match = match || this.gameState.every(board => board[tileY][tileX] === player)\r\n\r\n        if (match) return true\r\n\r\n        // 3D diagonals\r\n        // Not in location unreachable by a diagonal\r\n        if (boardIndex !== mid || boardIndex===mid && (tileY===mid || tileX===mid)) {\r\n\r\n            match = match\r\n                ||  this.gameState.every((board, bi) => board[max-bi][tileX]===player) // Near-bottom -> Far-top\r\n                ||  this.gameState.every((board, bi) => board[bi][tileX]===player) // Far-bottom -> Near-top\r\n                ||  this.gameState.every((board, bi) => board[tileY][max-bi]===player) // Bottom-left -> Top-right\r\n                ||  this.gameState.every((board, bi) => board[tileY][bi]===player) // Bottom-right -> Top-left\r\n\r\n\r\n            if (match) return true\r\n\r\n            // Check cross diagonal (going from corners through the middle)\r\n            if (this.gameState[mid][mid][mid]===player) {\r\n\r\n                match = match\r\n                    ||  this.gameState.every((board, bi) => board[bi][bi]===player) // Far-bottom-left -> Near-top-right\r\n                    ||  this.gameState.every((board, bi) => board[max-bi][bi]===player) // Near-bottom-left -> Far-top-right\r\n                    ||  this.gameState.every((board, bi) => board[max-bi][max-bi]===player) // Near-bottom-right -> Far-top-left\r\n                    ||  this.gameState.every((board, bi) => board[bi][max-bi]===player) // Far-bottom-right -> Near-top-left\r\n            }\r\n        }\r\n\r\n        return match\r\n    }\r\n\r\n    isFull () {\r\n\r\n        /*\r\n                Temporarily check only the first board, when training AI\r\n        */\r\n        if (this.isTraining) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (this.gameState[0][r][c] === \" \") {\r\n                        return false\r\n                    }\r\n                }\r\n            }\r\n            return true\r\n        }\r\n\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (this.gameState[b][r][c] === \" \") {\r\n                        return false\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    applyGravityToMove (board, row, col) {\r\n\r\n        if (!this.gravityEnabled) return [board, row, col]\r\n\r\n        let counts\r\n\r\n        switch (this.gravity.axis) {\r\n            // Up/Down\r\n            case 0:\r\n                counts = this.gravity.modifier==-1 ? board : this.span-1-board\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board + this.gravity.modifier][row][col]===\" \") {\r\n                        board += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n            // Left/Right\r\n            case 1:\r\n\r\n                counts = this.gravity.modifier==-1 ? col : this.span-1-col\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board][row][col + this.gravity.modifier]===\" \") {\r\n                        col += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n            // Forward/Backward\r\n            case 2:\r\n\r\n                counts = this.gravity.modifier==-1 ? row : this.span-1-row\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board][row + this.gravity.modifier][col]===\" \") {\r\n                        row += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n        }\r\n\r\n        return [board, row, col]\r\n    }\r\n\r\n    /*\r\n        TODO, there's a bug where some points don't move as needed. I think this may be due\r\n        to the order in which the tiles are moved\r\n    */\r\n    shiftGravity (direction) {\r\n\r\n        this.gravity.axis = this.directions[direction]\r\n        this.gravity.modifier = this.modifiers[direction]\r\n\r\n        const max = Math.abs((this.gravity.modifier==-1 ? this.span-1 : 0)-(this.span-1))\r\n\r\n        switch (this.gravity.axis) {\r\n\r\n            // Up/Down (boards)\r\n            case 0:\r\n                // For every row\r\n                for (let r=0; r<this.span; r++) {\r\n                    // For every column\r\n                    for (let c=0; c<this.span; c++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyBoard:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[Math.abs(max-i)][r][c]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[Math.abs(max-i2)][r][c] !== \" \") {\r\n                                        this.gameState[Math.abs(max-i)][r][c] = this.gameState[Math.abs(max-i2)][r][c]\r\n                                        this.gameState[Math.abs(max-i2)][r][c] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyBoard\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                break\r\n\r\n            // Left/Right (columns)\r\n            case 1:\r\n\r\n                // For every board\r\n                for (let b=0; b<this.span; b++) {\r\n                    // For every row\r\n                    for (let r=0; r<this.span; r++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyColumn:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[b][r][Math.abs(max-i)]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[b][r][Math.abs(max-i2)]!==\" \") {\r\n                                        this.gameState[b][r][Math.abs(max-i)] = this.gameState[b][r][Math.abs(max-i2)]\r\n                                        this.gameState[b][r][Math.abs(max-i2)] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyColumn\r\n                            }\r\n\r\n                        }\r\n\r\n                    }\r\n                }\r\n                break\r\n\r\n            // Forward/Backward (rows)\r\n            case 2:\r\n\r\n                // For every board\r\n                for (let b=0; b<this.span; b++) {\r\n                    // For every row\r\n                    for (let r=0; r<this.span; r++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyColumn:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[b][Math.abs(max-i)][r]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[b][Math.abs(max-i2)][r]!==\" \") {\r\n                                        this.gameState[b][Math.abs(max-i)][r] = this.gameState[b][Math.abs(max-i2)][r]\r\n                                        this.gameState[b][Math.abs(max-i2)][r] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyColumn\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                break\r\n        }\r\n\r\n        this.board.render(this.gameState)\r\n        this.checkAll()\r\n    }\r\n\r\n    // Check the game status for all placed items (when the gravity is changed, and every item is potentially re-arranged)\r\n    // TODO, optimize this, as this is insanely inefficient\r\n    checkAll () {\r\n        let match = false\r\n        let player\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n\r\n                    if (this.gameState[b][r][c] !== \" \") {\r\n                        match = match || this.winningMove(b, r, c, this.gameState[b][r][c])\r\n                        if (match) {\r\n                            player = this.gameState[b][r][c]\r\n                            break\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        if (match) {\r\n            playerNum.style.color = this.board.playerColours[player]\r\n            winsDisplay.style.display = \"inline-block\"\r\n        } else {\r\n            this.playerIndex = ++this.playerIndex % this.players.length\r\n            winsDisplay.style.display = \"none\"\r\n            playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        }\r\n    }\r\n\r\n}\r\n\"use strict\"\r\n\r\nclass GamePlayer {// eslint-disable-line\r\n\r\n    constructor (type, playerIndex, game, {epsilon=0.2, alpha=0.3, gamma=0.9}={}) {\r\n\r\n        console.log(`new ${type} player: ${playerIndex}`)\r\n\r\n        this.type = type\r\n        this.game = game // Two way binding\r\n        this.playerIndex = playerIndex\r\n\r\n        if (type == \"AI\") {\r\n            this.q = {}\r\n            this.epsilon = epsilon\r\n            this.alpha = alpha\r\n            this.gamma = gamma\r\n            // this.lastState = game.gameState.slice(0)\r\n            this.lastState = JSON.parse(JSON.stringify(game.gameState))\r\n            this.lastMove = undefined\r\n        }\r\n    }\r\n\r\n    getQ (state, action) {\r\n\r\n        const key = state.join(\"\").replace(/,/g,\"\").replace(/0/g, \"X\").replace(/1/g, \"O\") + action\r\n\r\n        if (this.q[key]==undefined) {\r\n            this.q[key] = 1\r\n        }\r\n\r\n        return this.q[key]\r\n    }\r\n\r\n    // TODO, include multiple boards, when the time comes\r\n    getAvailableMoves (gameState) {\r\n        const moves = []\r\n\r\n        for (let r=0; r<this.game.span; r++) {\r\n            for (let c=0; c<this.game.span; c++) {\r\n                if (Number.isNaN(parseInt(gameState[0][r][c]))) {\r\n                    moves.push(r*this.game.span + c)\r\n                }\r\n            }\r\n        }\r\n\r\n        // console.log(moves.length, \"getAvailableMoves\")\r\n        return moves\r\n    }\r\n\r\n    pickMove (gameState) {\r\n\r\n        if (this.type != \"AI\") return\r\n\r\n        // Deep copy - TODO, optimize\r\n        this.lastState = JSON.parse(JSON.stringify(gameState))\r\n        const moves = this.getAvailableMoves(this.lastState)\r\n\r\n        // Explore\r\n        if (Math.random() < this.epsilon) {\r\n            const index = Math.floor(Math.random() * moves.length)\r\n            this.lastMove = moves[index]\r\n            this.game.makeMove(this.playerIndex, 0, parseInt(this.lastMove/this.game.span), this.lastMove%this.game.span)\r\n            return\r\n        }\r\n\r\n        const qs = []\r\n\r\n        for (let m=0; m<moves.length; m++) {\r\n            qs.push(this.getQ(this.lastState, moves[m]))\r\n        }\r\n\r\n        const maxQ = qs.slice(0).sort().reverse()[0]\r\n\r\n        this.lastMove = moves[qs.indexOf(maxQ)]\r\n        this.game.makeMove(this.playerIndex, 0, parseInt(this.lastMove/this.game.span), this.lastMove%this.game.span)\r\n    }\r\n\r\n    reward (value, gameState) {\r\n\r\n        if (this.type != \"AI\") return\r\n\r\n        if (this.lastMove) {\r\n\r\n            const prev = this.getQ(this.lastState, this.lastMove)\r\n            const aMoves = this.getAvailableMoves(this.lastState)\r\n            let maxqNew = 0\r\n\r\n            for (let a=0; a<aMoves.length; a++) {\r\n                maxqNew = Math.max(maxqNew, this.getQ(gameState, aMoves[a]))\r\n            }\r\n\r\n            const key = this.lastState.join(\"\").replace(/,/g,\"\").replace(/0/g, \"X\").replace(/1/g, \"O\") + this.lastMove\r\n            this.q[key] = prev + this.alpha * (value + this.gamma * maxqNew - prev)\r\n        }\r\n    }\r\n\r\n}\n//# sourceMappingURL=game.concat.js.map"]}