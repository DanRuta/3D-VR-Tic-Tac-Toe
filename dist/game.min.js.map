{"version":3,"sources":["game.concat.js"],"names":["GameBoard","[object Object]","game","span","this","playerColours","rotation","BOX_WIDTH","SPREAD","Math","floor","SPACING","SPHERE_RADIUS","SPHERE_V_COUNT","OPACITY_ON","OPACITY_OFF","explodedMult","isLerpingBoxes","colours","RED","BLUE","GREEN","PURPLE","YELLOW","ORANGE","BLACK","CYAN","PINK","LIGHTGREY","DARKGREY","WHITE","scene","THREE","Scene","camera","PerspectiveCamera","window","innerWidth","innerHeight","raycaster","Raycaster","mouse","Vector2","renderer","WebGLRenderer","alpha","antialias","setPixelRatio","devicePixelRatio","setSize","domElement","id","boardElement","light","DirectionalLight","position","set","normalize","add","y","previewColour","playerIndex","toUpperCase","previewSphereGeometry","SphereGeometry","previewSphereMaterial","MeshLambertMaterial","color","transparent","opacity","emissive","setHex","previewSphere","Mesh","initBoards","renderLoop","rotate","addEventListener","event","sizeY","target","height","sizeX","width","x","offsetX","offsetY","highlightedBoxes","boxes","Array","map","spheres","b","r","c","addBox","geometry","BoxGeometry","material","box","z","data","origPos","colour","sphereGeometry","sphereMaterial","sphere","length","push","cube","incr","gravity","modifier","pos","gravityEnabled","axis","start","end","location","isLerping","newPos","requestAnimationFrame","abs","someSphereIsLerping","lookAt","updateMatrixWorld","render","setFromCamera","intersects","intersectObjects","children","hoveredObject","object","parent","clearHighlightedBoxes","highlightColumn","highlightRowY","highlightRowX","getPreviewPosition","mouseIsDown","isClicked","setTimeout","gameState","makeMove","board","row","col","player","nextPlayer","addSphere","setPreviewColour","resetBoard","addPoint","remove","undefined","sin","PI","cos","exports","GameLogic","players","isTraining","isMultiplayer","aiOpponent","parseInt","numPlayers","resetGame","directions","up","down","left","right","forward","backward","modifiers","random","GamePlayer","p","pickMove","boardGameState","rowGameState","type","clearLastState","console","log","reward","applyGravityToMove","isWinningMove","forEach","pi","isFull","boardIndex","tileY","tileX","match","max","mid","every","ri","bi","counts","i","direction","i2","everyBoard","moveSphere","everyColumn","checkAll","lastState","lastMove","fetch","method","body","JSON","stringify","then","json","move","value"],"mappings":"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","file":"game.min.js","sourcesContent":["\"use strict\"\r\n\r\nclass GameBoard {// eslint-disable-line\r\n\r\n    constructor (game) {\r\n\r\n        const {span} = game\r\n\r\n        this.playerColours = [\"blue\", \"red\", \"green\", \"purple\", \"yellow\", \"orange\", \"black\", \"cyan\", \"pink\", \"darkgrey\"]\r\n        this.rotation = -45\r\n        this.span = span\r\n        this.game = game // Two way binding\r\n\r\n        // Rendering constants\r\n        this.BOX_WIDTH = 0.5\r\n        this.SPREAD = Math.floor(this.span / 2)\r\n        this.SPACING = 1.5\r\n        this.SPHERE_RADIUS = 0.2\r\n        this.SPHERE_V_COUNT = 50\r\n        this.OPACITY_ON = 0.5\r\n        this.OPACITY_OFF = 0.25\r\n\r\n        this.explodedMult = 1\r\n        this.isLerpingBoxes = false\r\n\r\n        this.colours = {\r\n            RED: 0xff0000,\r\n            BLUE: 0x0000ff,\r\n            GREEN: 0x00ff00,\r\n            PURPLE: 0x880088,\r\n            YELLOW: 0xffff00,\r\n            ORANGE: 0xff6600,\r\n            BLACK: 0x000000,\r\n            CYAN: 0x00ffff,\r\n            PINK: 0xffc0cb,\r\n            LIGHTGREY: 0x999999,\r\n            DARKGREY: 0x666666,\r\n            WHITE: 0xffffff\r\n        }\r\n\r\n        this.scene = new THREE.Scene()\r\n        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)\r\n        this.raycaster = new THREE.Raycaster()\r\n        this.mouse = new THREE.Vector2()\r\n        this.renderer = new THREE.WebGLRenderer({alpha: true, antialias: true})\r\n        this.renderer.setPixelRatio(window.devicePixelRatio)\r\n        this.renderer.setSize(window.innerWidth-100, window.innerHeight-200)\r\n        this.renderer.domElement.id = \"rendererDomElement\"\r\n        this.boardElement = this.renderer.domElement\r\n\r\n        const light = new THREE.DirectionalLight(this.colours.LIGHTGREY, 1)\r\n        light.position.set(1, 1, 1).normalize()\r\n        this.scene.add(light)\r\n\r\n        this.camera.position.y = 2\r\n\r\n        // Create a render sphere to move around to the correct location\r\n        const previewColour = this.colours[this.playerColours[this.game.playerIndex].toUpperCase()]\r\n        const previewSphereGeometry = new THREE.SphereGeometry(this.SPHERE_RADIUS, this.SPHERE_V_COUNT, this.SPHERE_V_COUNT)\r\n        const previewSphereMaterial = new THREE.MeshLambertMaterial({color: previewColour, transparent: true})\r\n        previewSphereMaterial.opacity = 0\r\n        previewSphereMaterial.emissive.setHex(previewColour) // TOOD, player colour\r\n        this.previewSphere = new THREE.Mesh(previewSphereGeometry, previewSphereMaterial)\r\n        this.scene.add(this.previewSphere)\r\n\r\n        this.initBoards()\r\n        this.renderLoop()\r\n        this.rotate()\r\n\r\n        this.boardElement.addEventListener(\"mousemove\", event => {\r\n            const sizeY = event.target.height\r\n            const sizeX = event.target.width\r\n            this.mouse.x = event.offsetX / sizeX * 2 - 1\r\n            this.mouse.y = -event.offsetY / sizeY * 2 + 1\r\n        }, false)\r\n    }\r\n\r\n    // Create volumes to store the boxes / spheres\r\n    initBoards () {\r\n        this.highlightedBoxes = []\r\n        this.boxes = [...new Array(this.span)].map(() => [...new Array(this.span)].map(() => [...new Array(this.span)]))\r\n        this.spheres = [...new Array(this.span)].map(() => [...new Array(this.span)].map(() => [...new Array(this.span)]))\r\n\r\n        // Populate the canvas with the board cubes\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    this.addBox(b, r, c)\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    addBox (b, r, c) {\r\n        const geometry = new THREE.BoxGeometry(this.BOX_WIDTH, this.BOX_WIDTH, this.BOX_WIDTH)\r\n        const material = new THREE.MeshLambertMaterial({color: this.colours.DARKGREY})\r\n        material.opacity = this.OPACITY_OFF\r\n        material.transparent = true\r\n\r\n        const box = new THREE.Mesh(geometry, material)\r\n        box.material.emissive.setHex(this.colours.LIGHTGREY)\r\n\r\n        box.position.x = (c - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        box.position.y = (b - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        box.position.z = (r - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        box.data = {b, r, c}\r\n        box.origPos = {\r\n            x: box.position.x,\r\n            y: box.position.y,\r\n            z: box.position.z\r\n        }\r\n\r\n        this.scene.add(box)\r\n        this.boxes[b][r][c] = box\r\n    }\r\n\r\n    addSphere (b, r, c, colour) {\r\n        const sphereGeometry = new THREE.SphereGeometry(this.SPHERE_RADIUS, this.SPHERE_V_COUNT, this.SPHERE_V_COUNT)\r\n        const sphereMaterial = new THREE.MeshLambertMaterial({color: this.colours[colour.toUpperCase()]})\r\n        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial)\r\n        sphere.material.emissive.setHex(this.colours[colour.toUpperCase()])\r\n\r\n        sphere.position.x = (c - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        sphere.position.y = (b - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        sphere.position.z = (r - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        sphere.origPos = {\r\n            x: sphere.position.x,\r\n            y: sphere.position.y,\r\n            z: sphere.position.z\r\n        }\r\n\r\n        // Set the sphere position to the exploded position\r\n        if (this.explodedMult!=1) {\r\n            sphere.position.x += sphere.origPos.x * this.explodedMult - sphere.position.x\r\n            sphere.position.y += sphere.origPos.y * this.explodedMult - sphere.position.y\r\n            sphere.position.z += sphere.origPos.z * this.explodedMult - sphere.position.z\r\n        }\r\n\r\n        this.spheres[b][r][c] = sphere\r\n        this.scene.add(sphere)\r\n    }\r\n\r\n    clearHighlightedBoxes () {\r\n        for (let b=0; b<this.highlightedBoxes.length; b++) {\r\n            this.highlightedBoxes[b].material.opacity = this.OPACITY_OFF\r\n            this.highlightedBoxes[b].material.emissive.setHex(this.colours.LIGHTGREY)\r\n        }\r\n        this.highlightedBoxes = []\r\n        this.previewSphere.material.opacity = 0\r\n    }\r\n\r\n    highlightColumn ({r, c}) {\r\n        for (let b=0; b<this.span; b++) {\r\n            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n        }\r\n    }\r\n\r\n    highlightRowY ({b, r}) {\r\n        for (let c=0; c<this.span; c++) {\r\n            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n        }\r\n    }\r\n\r\n    highlightRowX ({b, c}) {\r\n        for (let r=0; r<this.span; r++) {\r\n            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n        }\r\n    }\r\n\r\n    getPreviewPosition (cube) {\r\n\r\n        const incr = this.game.gravity.modifier\r\n        const pos = {\r\n            x : cube.origPos.x,\r\n            y : cube.origPos.y,\r\n            z : cube.origPos.z\r\n        }\r\n\r\n        pos.b = cube.data.b\r\n        pos.r = cube.data.r\r\n        pos.c = cube.data.c\r\n\r\n        if (!this.game.gravityEnabled) {\r\n            return pos\r\n        }\r\n\r\n        switch (this.game.gravity.axis) {\r\n            // up/down\r\n            case 0:\r\n                // Column full\r\n                if (this.spheres[incr==-1 ? this.span-1 : 0][cube.data.r][cube.data.c]) {\r\n                    return null\r\n                }\r\n\r\n                pos.b = incr==-1 ? 0 : this.span-1\r\n\r\n                while (this.spheres[pos.b][cube.data.r][cube.data.c]) {\r\n                    pos.b -= incr\r\n                }\r\n\r\n                pos.y = (pos.b - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n                break\r\n\r\n            // left/right\r\n            case 1:\r\n                // Row full\r\n                if (this.spheres[cube.data.b][cube.data.r][incr==-1 ? this.span-1 : 0]) {\r\n                    return null\r\n                }\r\n\r\n                pos.c = incr==-1 ? 0 : this.span-1\r\n\r\n                while (this.spheres[cube.data.b][cube.data.r][pos.c]) {\r\n                    pos.c -= incr\r\n                }\r\n\r\n                pos.x = (pos.c - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n                break\r\n            // forward/backward\r\n            case 2:\r\n                // Row full\r\n                if (this.spheres[cube.data.b][incr==-1 ? this.span-1 : 0][cube.data.c]) {\r\n                    return null\r\n                }\r\n\r\n                pos.r = incr==-1 ? 0 : this.span-1\r\n\r\n                while (this.spheres[cube.data.b][pos.r][cube.data.c]) {\r\n                    pos.r -= incr\r\n                }\r\n\r\n                pos.z = (pos.r - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n                break\r\n        }\r\n\r\n        if (this.explodedMult!=1) {\r\n            pos.x *= this.explodedMult\r\n            pos.y *= this.explodedMult\r\n            pos.z *= this.explodedMult\r\n        }\r\n\r\n        // Don't render it if there's already a sphere at that location\r\n        if (this.spheres[pos.b][pos.r][pos.c]) {\r\n            return null\r\n        }\r\n\r\n        return pos\r\n    }\r\n\r\n    moveSphere (start, end, axis, location) {\r\n\r\n        // Set the new position for the sphere\r\n        const sphere = this.spheres[start.b][start.r][start.c]\r\n        sphere.isLerping = true\r\n        sphere.newPos = {}\r\n        sphere.newPos.axis = axis\r\n        sphere.newPos[axis] = (location - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n\r\n        // Move the spheres in the spheres state\r\n        this.spheres[end.b][end.r][end.c] = sphere\r\n        this.spheres[start.b][start.r][start.c] = null\r\n    }\r\n\r\n    renderLoop () {\r\n        requestAnimationFrame(() => this.renderLoop())\r\n\r\n        // Lerp the boxes into position, when exploded\r\n        if (this.isLerpingBoxes) {\r\n            for (let b=0; b<this.span; b++) {\r\n                for (let r=0; r<this.span; r++) {\r\n                    for (let c=0; c<this.span; c++) {\r\n\r\n                        if (b!=this.SPREAD && r!=this.SPREAD && c!=this.SPREAD\r\n                            && Math.abs(this.boxes[b][r][c].position.x - this.boxes[b][r][c].origPos.x * this.explodedMult) < 0.005) {\r\n\r\n                            this.isLerpingBoxes = false\r\n                            this.boxes[b][r][c].position.x = this.boxes[b][r][c].origPos.x * this.explodedMult\r\n                            this.boxes[b][r][c].position.y = this.boxes[b][r][c].origPos.y * this.explodedMult\r\n                            this.boxes[b][r][c].position.z = this.boxes[b][r][c].origPos.z * this.explodedMult\r\n\r\n                            if (this.spheres[b][r][c]) {\r\n                                this.spheres[b][r][c].position.x += this.spheres[b][r][c].origPos.x * this.explodedMult - this.spheres[b][r][c].position.x\r\n                                this.spheres[b][r][c].position.y += this.spheres[b][r][c].origPos.y * this.explodedMult - this.spheres[b][r][c].position.y\r\n                                this.spheres[b][r][c].position.z += this.spheres[b][r][c].origPos.z * this.explodedMult - this.spheres[b][r][c].position.z\r\n                            }\r\n\r\n                        } else {\r\n                            this.boxes[b][r][c].position.x += (this.boxes[b][r][c].origPos.x * this.explodedMult - this.boxes[b][r][c].position.x) / 10\r\n                            this.boxes[b][r][c].position.y += (this.boxes[b][r][c].origPos.y * this.explodedMult - this.boxes[b][r][c].position.y) / 10\r\n                            this.boxes[b][r][c].position.z += (this.boxes[b][r][c].origPos.z * this.explodedMult - this.boxes[b][r][c].position.z) / 10\r\n\r\n                            if (this.spheres[b][r][c]) {\r\n                                this.spheres[b][r][c].position.x += (this.spheres[b][r][c].origPos.x * this.explodedMult - this.spheres[b][r][c].position.x) / 10\r\n                                this.spheres[b][r][c].position.y += (this.spheres[b][r][c].origPos.y * this.explodedMult - this.spheres[b][r][c].position.y) / 10\r\n                                this.spheres[b][r][c].position.z += (this.spheres[b][r][c].origPos.z * this.explodedMult - this.spheres[b][r][c].position.z) / 10\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        let someSphereIsLerping = false\r\n\r\n        // Lerp the spheres into their new place\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n\r\n                    if (this.spheres[b][r][c] && this.spheres[b][r][c].isLerping) {\r\n\r\n                        someSphereIsLerping = true\r\n\r\n                        const sphere = this.spheres[b][r][c]\r\n                        const {axis} = sphere.newPos\r\n\r\n                        if (Math.abs(sphere.position[axis] - sphere.newPos[axis] * this.explodedMult) > 0.01) {\r\n                            sphere.position[axis] += (sphere.newPos[axis] * this.explodedMult - sphere.position[axis]) / 10\r\n                        } else {\r\n                            sphere.isLerping = false\r\n                            sphere.position[axis] = sphere.newPos[axis] * this.explodedMult\r\n                            sphere.origPos[axis] = sphere.newPos[axis]\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        this.camera.lookAt(this.scene.position)\r\n        this.camera.updateMatrixWorld()\r\n\r\n        this.renderer.render(this.scene, this.camera)\r\n        this.raycaster.setFromCamera(this.mouse, this.camera)\r\n\r\n        const intersects = this.raycaster.intersectObjects(this.scene.children, true)\r\n\r\n        if (intersects.length) {\r\n\r\n            // If still hovering on the same thing...\r\n            if (this.hoveredObject && (this.hoveredObject==intersects[0].object || this.hoveredObject==intersects[0].object.parent)) {\r\n\r\n                if (this.mouseIsDown && !this.hoveredObject.data.isClicked) {\r\n                    this.hoveredObject.data.isClicked = true\r\n                    setTimeout(() => {\r\n                        if (this.hoveredObject) {\r\n                            this.hoveredObject.data.isClicked = false\r\n                        }\r\n                    }, 500)\r\n\r\n                    const {b, r, c} = this.previewSphere.data\r\n\r\n                    if (this.game.gameState[b][r][c]===\" \") {\r\n                        this.game.makeMove(this.game.playerIndex, b, r, c)\r\n                    }\r\n                }\r\n\r\n            } else {\r\n\r\n                // Set the currently hovered over object\r\n                this.hoveredObject = intersects[0].object.data ? intersects[0].object : intersects[0].object.parent\r\n                this.clearHighlightedBoxes()\r\n\r\n                if (this.hoveredObject.data) {\r\n                    // Also TODO, decide which one of these to do, based on the current gravity\r\n\r\n                    if (!this.isLerpingBoxes && !someSphereIsLerping) {\r\n\r\n                        if (this.game.gravityEnabled) {\r\n                            switch (this.game.gravity.axis) {\r\n                                case 0:\r\n                                    this.highlightColumn(this.hoveredObject.data)\r\n                                    break\r\n                                case 1:\r\n                                    this.highlightRowY(this.hoveredObject.data)\r\n                                    break\r\n                                case 2:\r\n                                    this.highlightRowX(this.hoveredObject.data)\r\n                                    break\r\n                            }\r\n                        } else {\r\n                            // Highlight only the hovered over box\r\n                            const {b, r, c} = this.hoveredObject.data\r\n                            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n                            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n                            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n                        }\r\n\r\n                        // Render the preview sphere at the correct location\r\n                        const pos = this.getPreviewPosition(this.hoveredObject)\r\n\r\n                        if (pos) {\r\n                            this.previewSphere.position.x = pos.x\r\n                            this.previewSphere.position.y = pos.y\r\n                            this.previewSphere.position.z = pos.z\r\n                            this.previewSphere.data = {\r\n                                b: pos.b,\r\n                                r: pos.r,\r\n                                c: pos.c\r\n                            }\r\n                            this.previewSphere.material.opacity = 0.5\r\n                        }\r\n                        // === ?\r\n                        // else {\r\n                        //     this.previewSphere.material.opacity = 0\r\n                        // }\r\n                    }\r\n                }\r\n            }\r\n\r\n        } else {\r\n\r\n            this.clearHighlightedBoxes()\r\n            this.previewSphere.material.opacity = 0\r\n\r\n            if (this.hoveredObject) {\r\n                if (this.hoveredObject.material) {\r\n                    this.hoveredObject.material.emissive.setHex(this.colours.LIGHTGREY)\r\n                    this.hoveredObject.material.opacity = this.OPACITY_OFF\r\n                    this.hoveredObject.data.isClicked = false\r\n                } else if (this.hoveredObject.parent) {\r\n                    this.hoveredObject.parent.material.emissive.setHex(this.colours.LIGHTGREY)\r\n                    this.hoveredObject.parent.material.opacity = this.OPACITY_OFF\r\n                    this.hoveredObject.parent.data.isClicked = false\r\n                }\r\n\r\n            }\r\n            this.hoveredObject = null\r\n        }\r\n    }\r\n\r\n    toggleExploded () {\r\n        this.explodedMult = this.explodedMult==1 ? 2 : 1\r\n        this.previewSphere.material.opacity = 0\r\n        this.isLerpingBoxes = true\r\n    }\r\n\r\n    addPoint (board, row, col, player, nextPlayer) {\r\n        this.addSphere(board, row, col, this.playerColours[player].toUpperCase())\r\n        this.previewSphere.material.opacity = 0\r\n        this.setPreviewColour(nextPlayer)\r\n    }\r\n\r\n    setPreviewColour (playerIndex) {\r\n        const previewColour = this.colours[this.playerColours[playerIndex].toUpperCase()]\r\n        this.previewSphere.material.color.setHex(previewColour)\r\n        this.previewSphere.material.emissive.setHex(previewColour)\r\n    }\r\n\r\n    render (gameState) {\r\n        this.resetBoard()\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (gameState[b][r][c]) {\r\n                        this.addPoint(b, r, c, gameState[b][r][c])\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    resetBoard () {\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (this.spheres[b][r][c]) {\r\n                        this.scene.remove(this.spheres[b][r][c])\r\n                        this.spheres[b][r][c] = undefined\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    rotate () {\r\n        this.camera.position.x = Math.sin(this.rotation*Math.PI/180) * (this.BOX_WIDTH * 1.5) * this.span * 2\r\n        this.camera.position.z = Math.cos(this.rotation*Math.PI/180) * (this.BOX_WIDTH * 1.5) * this.span * 2\r\n    }\r\n\r\n}\r\n\r\ntypeof window!=\"undefined\" && (window.exports = window.exports || {})\r\n\"use strict\"\r\n\r\nclass GameLogic {// eslint-disable-line\r\n\r\n    constructor ({gameState, gravityEnabled=true, span=3, players=2, isTraining, isMultiplayer, aiOpponent}={}) {\r\n\r\n        this.players = []\r\n        this.gravityEnabled = gravityEnabled\r\n        this.span = parseInt(span)\r\n        this.numPlayers = parseInt(players)\r\n        this.isTraining = isTraining // AI\r\n        this.aiOpponent = aiOpponent // AI\r\n        this.isMultiplayer = isMultiplayer // TODO, will be used to disallow moves until a move is made via WebSocket\r\n\r\n        this.gameState = gameState || this.resetGame() // Allow accepting an existing game state to allow loading existing match\r\n        this.gravity = {\r\n            axis: 0, // 0 for up/down, 1 for left/right, 2 for  forward/backward\r\n            modifier: -1 // -1 for normal, 1 for reverse\r\n        }\r\n        this.directions = {\r\n            up: 0,\r\n            down: 0,\r\n            left: 1,\r\n            right: 1,\r\n            forward: 2,\r\n            backward: 2\r\n        }\r\n        this.modifiers = {\r\n            up: 1,\r\n            down: -1,\r\n            left: -1,\r\n            right: 1,\r\n            forward: -1,\r\n            backward: 1\r\n        }\r\n\r\n        // Randomize who starts\r\n        this.playerIndex = Math.floor(Math.random()*players)\r\n        this.board = new GameBoard(this)\r\n\r\n        // Set the first player to either AI or human (aka the actual player)\r\n        if (this.aiOpponent) {\r\n            this.players.push(new GamePlayer(\"AI\", 0, this))\r\n        } else {\r\n            this.players.push(new GamePlayer(\"local human\", 0))\r\n        }\r\n\r\n        // Set the rest to whatever was configured\r\n        for (let p=1; p<players; p++) {\r\n\r\n            // TODO, disallow more than 1 other player when playing against AI - model needed would be too big\r\n            if (this.isTraining) {\r\n                this.players.push(new GamePlayer(\"AI\", p, this))\r\n            } else if (isMultiplayer) {\r\n                this.players.push(new GamePlayer(\"remote human\", p))\r\n            } else {\r\n                this.players.push(new GamePlayer(\"local human\", p))\r\n            }\r\n        }\r\n\r\n        // playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        this.players[this.playerIndex].pickMove(this.gameState)\r\n    }\r\n\r\n    // Create the board brand new\r\n    resetGame () {\r\n\r\n        const gameState = []\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n\r\n            const boardGameState = []\r\n\r\n            for (let r=0; r<this.span; r++) {\r\n\r\n                const rowGameState = []\r\n\r\n                for (let c=0; c<this.span; c++) {\r\n                    rowGameState.push(\" \")\r\n                }\r\n\r\n                boardGameState.push(rowGameState)\r\n            }\r\n            gameState.push(boardGameState)\r\n        }\r\n\r\n        if (this.board) {\r\n            this.board.resetBoard()\r\n            // playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        }\r\n\r\n        // winsDisplay.style.display = \"none\"\r\n        this.gameState = gameState\r\n\r\n        // Clear the AI players' lastState\r\n        for (let p=0; p<this.players.length; p++) {\r\n            if (this.players[p].type == \"AI\") {\r\n                this.players[p].clearLastState()\r\n            }\r\n        }\r\n\r\n        return gameState\r\n    }\r\n\r\n    makeMove (p, b, r, c) {\r\n\r\n        if (p != this.playerIndex && !this.isTraining) {\r\n            console.log(\"NOT your turn!\")\r\n            return\r\n        }\r\n\r\n        // Illegal move\r\n        if (this.gameState[b][r][c] !== \" \") {\r\n            console.log(\"Illegal move\")\r\n\r\n            // Slap its hands, if it was an AI player\r\n            this.players[p].reward(-99, this.gameState)\r\n\r\n            // Stop the game if it's an AI, to avoid looping to stack overflow\r\n            if (this.players[p].type==\"AI\") {\r\n                this.resetGame()\r\n            }\r\n\r\n            return\r\n        }\r\n\r\n        [b, r, c] = this.applyGravityToMove(b, r, c)\r\n\r\n        this.gameState[b][r][c] = p\r\n        this.board.addPoint(b, r, c, p, (this.playerIndex+1) % this.players.length)\r\n\r\n        // Player wins\r\n        if (this.isWinningMove(b, r, c, p)) {\r\n            this.players[p].reward(1, this.gameState)\r\n            this.players.forEach((player, pi) => pi!=p && player.reward(-1, this.gameState))\r\n            // winsDisplay.style.display = \"inline-block\"\r\n            return\r\n        }\r\n\r\n        // Tied game\r\n        if (this.isFull()) {\r\n            console.log(\"Tied game\")\r\n            this.players.forEach(player => player.reward(0.25, this.gameState))\r\n            return\r\n        }\r\n\r\n\r\n        // TODO, this might be useless - TEST\r\n        this.players.forEach((player, pi) => pi!=p && player.reward(0, this.gameState))\r\n\r\n        this.playerIndex = ++this.playerIndex % this.players.length\r\n\r\n        // TODO, do this outside of this class?\r\n        // playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        // winsDisplay.style.display = \"none\"\r\n\r\n        this.players[this.playerIndex].pickMove(this.gameState)\r\n    }\r\n\r\n    isWinningMove (boardIndex, tileY, tileX, player) {\r\n\r\n        let match = false\r\n        const max = this.gameState[0].length-1\r\n        const mid = Math.floor(max/2)\r\n\r\n        // Check current board\r\n        match = this.gameState[boardIndex][tileY].every(col => col===player) // Horizontal\r\n            ||  this.gameState[boardIndex].every(row => row[tileX]===player) // Vertical\r\n            ||  (tileX + tileY)%2 === 0 && ( // Is it on a diagonal?\r\n                // Diagonal top-left -> bottom-right\r\n                this.gameState[boardIndex].every((row, ri) => row[ri]===player) ||\r\n                // Diagonal bottom-left -> top-right\r\n                this.gameState[boardIndex].every((row, ri) => row[max-ri]===player)\r\n            )\r\n\r\n        // Check other boards\r\n        // Up/Down\r\n        match = match || this.gameState.every(board => board[tileY][tileX] === player)\r\n\r\n        if (match) return true\r\n\r\n        // 3D diagonals\r\n        // Not in location unreachable by a diagonal\r\n        if (boardIndex !== mid || boardIndex===mid && (tileY===mid || tileX===mid)) {\r\n\r\n            match = match\r\n                ||  this.gameState.every((board, bi) => board[max-bi][tileX]===player) // Near-bottom -> Far-top\r\n                ||  this.gameState.every((board, bi) => board[bi][tileX]===player) // Far-bottom -> Near-top\r\n                ||  this.gameState.every((board, bi) => board[tileY][max-bi]===player) // Bottom-left -> Top-right\r\n                ||  this.gameState.every((board, bi) => board[tileY][bi]===player) // Bottom-right -> Top-left\r\n\r\n\r\n            if (match) return true\r\n\r\n            // Check cross diagonal (going from corners through the middle)\r\n            if (this.gameState[mid][mid][mid]===player) {\r\n\r\n                match = match\r\n                    ||  this.gameState.every((board, bi) => board[bi][bi]===player) // Far-bottom-left -> Near-top-right\r\n                    ||  this.gameState.every((board, bi) => board[max-bi][bi]===player) // Near-bottom-left -> Far-top-right\r\n                    ||  this.gameState.every((board, bi) => board[max-bi][max-bi]===player) // Near-bottom-right -> Far-top-left\r\n                    ||  this.gameState.every((board, bi) => board[bi][max-bi]===player) // Far-bottom-right -> Near-top-left\r\n            }\r\n        }\r\n\r\n        return match\r\n    }\r\n\r\n    isFull () {\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (this.gameState[b][r][c] === \" \") {\r\n                        return false\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    applyGravityToMove (board, row, col) {\r\n\r\n        if (!this.gravityEnabled) return [board, row, col]\r\n\r\n        let counts\r\n\r\n        switch (this.gravity.axis) {\r\n            // Up/Down\r\n            case 0:\r\n                counts = this.gravity.modifier==-1 ? board : this.span-1-board\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board + this.gravity.modifier][row][col]===\" \") {\r\n                        board += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n            // Left/Right\r\n            case 1:\r\n\r\n                counts = this.gravity.modifier==-1 ? col : this.span-1-col\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board][row][col + this.gravity.modifier]===\" \") {\r\n                        col += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n            // Forward/Backward\r\n            case 2:\r\n\r\n                counts = this.gravity.modifier==-1 ? row : this.span-1-row\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board][row + this.gravity.modifier][col]===\" \") {\r\n                        row += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n        }\r\n\r\n        return [board, row, col]\r\n    }\r\n\r\n    /*\r\n        TODO, there's a bug where some points don't move as needed. I think this may be due\r\n        to the order in which the tiles are moved\r\n    */\r\n    shiftGravity (direction) {\r\n\r\n        this.gravity.axis = this.directions[direction]\r\n        this.gravity.modifier = this.modifiers[direction]\r\n\r\n        const max = Math.abs((this.gravity.modifier==-1 ? this.span-1 : 0)-(this.span-1))\r\n\r\n        switch (this.gravity.axis) {\r\n\r\n            // Up/Down (boards)\r\n            case 0:\r\n                // For every row\r\n                for (let r=0; r<this.span; r++) {\r\n                    // For every column\r\n                    for (let c=0; c<this.span; c++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyBoard:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[Math.abs(max-i)][r][c]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[Math.abs(max-i2)][r][c] !== \" \") {\r\n\r\n                                        this.board.moveSphere({b: Math.abs(max-i2), r, c}, {b: Math.abs(max-i), r, c}, \"y\", Math.abs(max-i))\r\n\r\n                                        this.gameState[Math.abs(max-i)][r][c] = this.gameState[Math.abs(max-i2)][r][c]\r\n                                        this.gameState[Math.abs(max-i2)][r][c] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyBoard\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                break\r\n\r\n            // Left/Right (columns)\r\n            case 1:\r\n\r\n                // For every board\r\n                for (let b=0; b<this.span; b++) {\r\n                    // For every row\r\n                    for (let r=0; r<this.span; r++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyColumn:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[b][r][Math.abs(max-i)]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[b][r][Math.abs(max-i2)]!==\" \") {\r\n\r\n                                        this.board.moveSphere({b, r, c: Math.abs(max-i2)}, {b, r, c: Math.abs(max-i)}, \"x\", Math.abs(max-i))\r\n\r\n                                        this.gameState[b][r][Math.abs(max-i)] = this.gameState[b][r][Math.abs(max-i2)]\r\n                                        this.gameState[b][r][Math.abs(max-i2)] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyColumn\r\n                            }\r\n\r\n                        }\r\n\r\n                    }\r\n                }\r\n                break\r\n\r\n            // Forward/Backward (rows)\r\n            case 2:\r\n\r\n                // For every board\r\n                for (let b=0; b<this.span; b++) {\r\n                    // For every row\r\n                    for (let r=0; r<this.span; r++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyColumn:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[b][Math.abs(max-i)][r]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[b][Math.abs(max-i2)][r]!==\" \") {\r\n\r\n                                        this.board.moveSphere({b, r: Math.abs(max-i2), c: r}, {b, r: Math.abs(max-i), c: r}, \"z\", Math.abs(max-i))\r\n\r\n                                        this.gameState[b][Math.abs(max-i)][r] = this.gameState[b][Math.abs(max-i2)][r]\r\n                                        this.gameState[b][Math.abs(max-i2)][r] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyColumn\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                break\r\n        }\r\n\r\n        this.checkAll()\r\n\r\n        this.board.clearHighlightedBoxes()\r\n        this.board.setPreviewColour(this.playerIndex)\r\n    }\r\n\r\n\r\n    // Check the game status for all placed items (when the gravity is changed, and every item is potentially re-arranged)\r\n    // TODO, optimize this, as this is insanely inefficient\r\n    checkAll () {\r\n        let match = false\r\n        let player\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n\r\n                    if (this.gameState[b][r][c] !== \" \") {\r\n                        match = match || this.isWinningMove(b, r, c, this.gameState[b][r][c])\r\n                        if (match) {\r\n                            player = this.gameState[b][r][c]\r\n                            break\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        return player\r\n\r\n\r\n        // if (match) {\r\n        //     playerNum.style.color = this.board.playerColours[player]\r\n        //     winsDisplay.style.display = \"inline-block\"\r\n        // } else {\r\n        //     this.playerIndex = ++this.playerIndex % this.players.length\r\n        //     winsDisplay.style.display = \"none\"\r\n        //     playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        // }\r\n    }\r\n\r\n}\r\n\r\ntypeof window!=\"undefined\" && (window.GameLogic = GameLogic)\r\nexports.GameLogic = GameLogic\r\n\"use strict\"\r\n\r\nclass GamePlayer {// eslint-disable-line\r\n\r\n    constructor (type, playerIndex, game) {\r\n\r\n        console.log(`new ${type} player: ${playerIndex}`)\r\n\r\n        this.type = type\r\n        this.game = game // Two way binding\r\n        this.playerIndex = playerIndex\r\n    }\r\n\r\n    clearLastState () {\r\n        for (let b=0; b<this.game.span; b++) {\r\n            for (let r=0; r<this.game.span; r++) {\r\n                for (let c=0; c<this.game.span; c++) {\r\n                    this.lastState[b][r][c] = \" \"\r\n                }\r\n            }\r\n        }\r\n        this.lastMove = undefined\r\n    }\r\n\r\n    pickMove (gameState) {\r\n\r\n        if (this.type != \"AI\") return\r\n\r\n        fetch(\"./getAIMove\", {\r\n            method: \"post\",\r\n            body: JSON.stringify({gameState})\r\n        })\r\n        .then(r => r.json())\r\n        .then(({move}) => {\r\n            const [b, r, c] = move\r\n            this.game.makeMove(this.playerIndex, b, r, c)\r\n        })\r\n    }\r\n\r\n    reward (value, gameState) {\r\n\r\n        if (this.type != \"AI\") return\r\n\r\n        fetch(\"./rewardAI\", {\r\n            method: \"post\",\r\n            body: JSON.stringify({value, gameState})\r\n        })\r\n    }\r\n\r\n}\r\n\r\ntypeof window!=\"undefined\" && (window.GamePlayer = GamePlayer)\r\nexports.GamePlayer = GamePlayer\n//# sourceMappingURL=game.concat.js.map"]}