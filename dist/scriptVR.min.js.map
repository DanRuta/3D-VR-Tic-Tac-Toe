{"version":3,"sources":["scriptVR.concat.js"],"names":["GameBoard","[object Object]","game","isVR","span","this","playerColours","rotation","heightOffset","BOX_WIDTH","SPREAD","Math","floor","SPACING","SPHERE_RADIUS","SPHERE_V_COUNT","OPACITY_ON","OPACITY_OFF","explodedMult","isLerpingBoxes","colours","RED","BLUE","GREEN","PURPLE","YELLOW","ORANGE","BLACK","CYAN","PINK","BRIGHTGREY","LIGHTGREY","DARKGREY","WHITE","previewColour","playerIndex","toUpperCase","previewSphereGeometry","THREE","SphereGeometry","previewSphereMaterial","MeshLambertMaterial","color","transparent","opacity","emissive","setHex","previewSphere","Mesh","scene","Scene","camera","PerspectiveCamera","window","innerWidth","innerHeight","raycaster","Raycaster","mouse","Vector2","renderer","WebGLRenderer","alpha","antialias","setPixelRatio","devicePixelRatio","setSize","domElement","id","boardElement","light","DirectionalLight","position","set","normalize","add","y","initBoards","renderLoop","rotate","addEventListener","event","sizeY","target","height","sizeX","width","x","offsetX","offsetY","highlightedBoxes","boxes","Array","map","spheres","b","r","c","addBox","geometry","BoxGeometry","material","box","z","data","origPos","colour","sphereGeometry","sphereMaterial","sphere","length","push","cube","incr","gravity","modifier","pos","gravityEnabled","axis","start","end","location","isLerping","newPos","abs","someSphereIsLerping","requestAnimationFrame","lerpBoxes","lerpSpheres","lookAt","updateMatrixWorld","render","setFromCamera","intersects","intersectObjects","children","hoveredObject","object","parent","clearHighlightedBoxes","highlightColumn","highlightRowY","highlightRowX","getPreviewPosition","mouseIsDown","isClicked","setTimeout","gameState","ws","sendMove","makeMove","board","row","col","player","nextPlayer","addSphere","undefined","setPreviewColour","index","arrowModel","arrowModels","filter","a","arrowIndex","clickedObject","forEach","resetBoard","Number","isNaN","parseInt","addPoint","remove","sin","PI","cos","exports","GamePlayer","type","console","log","lastState","lastMove","fetch","method","body","JSON","stringify","then","json","move","value","GameLogic","gameBoard","players","isTraining","isMultiplayer","aiOpponent","numPlayers","resetGame","directions","up","down","left","right","forward","backward","modifiers","random","p","pickMove","boardGameState","rowGameState","clearLastState","reward","applyGravityToMove","isWinningMove","pi","dispatchEvent","CustomEvent","detail","isFull","sendState","boardIndex","tileY","tileX","match","max","mid","every","ri","bi","counts","i","direction","i2","everyBoard","moveSphere","everyColumn","checkAll","VRGameBoard","super","arrowNames","items","loader","ObjectLoader","load","model","positions","rotations","document","style","cursor","highlightArrow","send","userId","username","room","roomNameValue","shiftGravity","arrow","getParameters","parameters","parametersString","search","substring","split","k","v","screen","keepAwake","appendChild","NoSleep","enable","href","includes","fullscreenEnabled","requestFullScreen","webkitFullscreenEnabled","webkitRequestFullScreen","mozFullScreenEnabled","mozRequestFullScreen","msFullScreenEnabled","msRequestFullScreen","vrDisplay","effect","VREffect","separation","navigator","getVRDisplays","displays","enterVRButton","getElementById","classList","contains","usingVR","userAgent","requestPresent","source","StereoEffect","order","controls","OrbitControls","setOrientationControls","VRControls","update","removeEventListener","g","loadTHREEjsItems","makeArrows","setRotation","deltaY","e","code","toggleExploded","getVideoFeedAttempts","getVideoFeed","mozGetUserMedia","video","facingMode","stream","src","URL","createObjectURL","err","alert","mediaDevices","getUserMedia","catch","webkitGetUserMedia","msGetUserMedia","createElement","autoplay","buffer","bufferC","getContext","lastX","lastY","newX","newY","foundWithinBounds","frameCounter","readCircle","drawImage","getImageData","avgX","avgY","counter","startR","startC","endR","endC","min","pixel","tempCursor","marginTop","leftM","marginLeft","moveCursor"],"mappings":"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","file":"scriptVR.min.js","sourcesContent":["\"use strict\"\r\n\r\nclass GameBoard {// eslint-disable-line\r\n\r\n    constructor (game, isVR) {\r\n\r\n        const {span} = game\r\n\r\n        this.playerColours = [\"blue\", \"red\", \"green\", \"purple\", \"yellow\", \"orange\", \"black\", \"cyan\", \"pink\", \"darkgrey\"]\r\n        this.rotation = -45\r\n        this.span = span\r\n        this.game = game // Two way binding\r\n        this.heightOffset = 0\r\n\r\n        // Rendering constants\r\n        this.BOX_WIDTH = 0.5\r\n        this.SPREAD = Math.floor(this.span / 2)\r\n        this.SPACING = 1.5\r\n        this.SPHERE_RADIUS = 0.2\r\n        this.SPHERE_V_COUNT = 50\r\n        this.OPACITY_ON = 0.5\r\n        this.OPACITY_OFF = 0.25\r\n\r\n        this.explodedMult = 1\r\n        this.isLerpingBoxes = false\r\n\r\n        this.colours = {\r\n            RED: 0xff0000,\r\n            BLUE: 0x0000ff,\r\n            GREEN: 0x00ff00,\r\n            PURPLE: 0x880088,\r\n            YELLOW: 0xffff00,\r\n            ORANGE: 0xff6600,\r\n            BLACK: 0x000000,\r\n            CYAN: 0x00ffff,\r\n            PINK: 0xffc0cb,\r\n            BRIGHTGREY: 0xaaaaaa,\r\n            LIGHTGREY: 0x999999,\r\n            DARKGREY: 0x666666,\r\n            WHITE: 0xffffff\r\n        }\r\n\r\n        // Create a render sphere to move around to the correct location\r\n        const previewColour = this.colours[this.playerColours[this.game.playerIndex].toUpperCase()]\r\n        const previewSphereGeometry = new THREE.SphereGeometry(this.SPHERE_RADIUS, this.SPHERE_V_COUNT, this.SPHERE_V_COUNT)\r\n        const previewSphereMaterial = new THREE.MeshLambertMaterial({color: previewColour, transparent: true})\r\n        previewSphereMaterial.opacity = 0\r\n        previewSphereMaterial.emissive.setHex(previewColour)\r\n        this.previewSphere = new THREE.Mesh(previewSphereGeometry, previewSphereMaterial)\r\n\r\n\r\n        if (isVR) return\r\n\r\n        this.scene = new THREE.Scene()\r\n        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000)\r\n        this.raycaster = new THREE.Raycaster()\r\n        this.mouse = new THREE.Vector2()\r\n        this.renderer = new THREE.WebGLRenderer({alpha: true, antialias: true})\r\n        this.renderer.setPixelRatio(window.devicePixelRatio)\r\n        this.renderer.setSize(window.innerWidth-100, window.innerHeight-200)\r\n        this.renderer.domElement.id = \"rendererDomElement\"\r\n        this.boardElement = this.renderer.domElement\r\n\r\n        const light = new THREE.DirectionalLight(this.colours.LIGHTGREY, 1)\r\n        light.position.set(1, 1, 1).normalize()\r\n        this.scene.add(light)\r\n\r\n        this.camera.position.y = 2\r\n\r\n        this.scene.add(this.previewSphere)\r\n\r\n        this.initBoards()\r\n        this.renderLoop()\r\n        this.rotate()\r\n\r\n        this.boardElement.addEventListener(\"mousemove\", event => {\r\n            const sizeY = event.target.height\r\n            const sizeX = event.target.width\r\n            this.mouse.x = event.offsetX / sizeX * 2 - 1\r\n            this.mouse.y = -event.offsetY / sizeY * 2 + 1\r\n        }, false)\r\n    }\r\n\r\n    // Create volumes to store the boxes / spheres\r\n    initBoards () {\r\n        this.highlightedBoxes = []\r\n        this.boxes = [...new Array(this.span)].map(() => [...new Array(this.span)].map(() => [...new Array(this.span)]))\r\n        this.spheres = [...new Array(this.span)].map(() => [...new Array(this.span)].map(() => [...new Array(this.span)]))\r\n\r\n        // Populate the canvas with the board cubes\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    this.addBox(b, r, c)\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    addBox (b, r, c) {\r\n        const geometry = new THREE.BoxGeometry(this.BOX_WIDTH, this.BOX_WIDTH, this.BOX_WIDTH)\r\n        const material = new THREE.MeshLambertMaterial({color: this.colours.DARKGREY})\r\n        material.opacity = this.OPACITY_OFF\r\n        material.transparent = true\r\n\r\n        const box = new THREE.Mesh(geometry, material)\r\n        box.material.emissive.setHex(this.colours.LIGHTGREY)\r\n\r\n        box.position.x = (c - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        box.position.y = (b - this.SPREAD) * this.BOX_WIDTH * this.SPACING + this.heightOffset\r\n        box.position.z = (r - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        box.data = {b, r, c}\r\n        box.origPos = {\r\n            x: box.position.x,\r\n            y: box.position.y,\r\n            z: box.position.z\r\n        }\r\n\r\n        this.scene.add(box)\r\n        this.boxes[b][r][c] = box\r\n    }\r\n\r\n    addSphere (b, r, c, colour) {\r\n        const sphereGeometry = new THREE.SphereGeometry(this.SPHERE_RADIUS, this.SPHERE_V_COUNT, this.SPHERE_V_COUNT)\r\n        const sphereMaterial = new THREE.MeshLambertMaterial({color: this.colours[colour.toUpperCase()]})\r\n        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial)\r\n        sphere.material.emissive.setHex(this.colours[colour.toUpperCase()])\r\n\r\n        sphere.position.x = (c - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        sphere.position.y = (b - this.SPREAD) * this.BOX_WIDTH * this.SPACING + this.heightOffset\r\n        sphere.position.z = (r - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n        sphere.origPos = {\r\n            x: sphere.position.x,\r\n            y: sphere.position.y,\r\n            z: sphere.position.z\r\n        }\r\n\r\n        // Set the sphere position to the exploded position\r\n        if (this.explodedMult!=1) {\r\n            sphere.position.x += sphere.origPos.x * this.explodedMult - sphere.position.x\r\n            sphere.position.y += sphere.origPos.y * this.explodedMult - sphere.position.y\r\n            sphere.position.z += sphere.origPos.z * this.explodedMult - sphere.position.z\r\n        }\r\n\r\n        this.spheres[b][r][c] = sphere\r\n        this.scene.add(sphere)\r\n    }\r\n\r\n    clearHighlightedBoxes () {\r\n        for (let b=0; b<this.highlightedBoxes.length; b++) {\r\n            this.highlightedBoxes[b].material.opacity = this.OPACITY_OFF\r\n            this.highlightedBoxes[b].material.emissive.setHex(this.colours.LIGHTGREY)\r\n        }\r\n        this.highlightedBoxes = []\r\n        this.previewSphere.material.opacity = 0\r\n    }\r\n\r\n    highlightColumn ({r, c}) {\r\n        for (let b=0; b<this.span; b++) {\r\n            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n        }\r\n    }\r\n\r\n    highlightRowY ({b, r}) {\r\n        for (let c=0; c<this.span; c++) {\r\n            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n        }\r\n    }\r\n\r\n    highlightRowX ({b, c}) {\r\n        for (let r=0; r<this.span; r++) {\r\n            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n        }\r\n    }\r\n\r\n    getPreviewPosition (cube) {\r\n\r\n        const incr = this.game.gravity.modifier\r\n        const pos = {\r\n            x : cube.origPos.x,\r\n            y : cube.origPos.y,\r\n            z : cube.origPos.z\r\n        }\r\n\r\n        pos.b = cube.data.b\r\n        pos.r = cube.data.r\r\n        pos.c = cube.data.c\r\n\r\n        if (!this.game.gravityEnabled) {\r\n            return pos\r\n        }\r\n\r\n        switch (this.game.gravity.axis) {\r\n            // up/down\r\n            case 0:\r\n                // Column full\r\n                if (this.spheres[incr==-1 ? this.span-1 : 0][cube.data.r][cube.data.c]) {\r\n                    return null\r\n                }\r\n\r\n                pos.b = incr==-1 ? 0 : this.span-1\r\n\r\n                while (this.spheres[pos.b][cube.data.r][cube.data.c]) {\r\n                    pos.b -= incr\r\n                }\r\n\r\n                pos.y = (pos.b - this.SPREAD) * this.BOX_WIDTH * this.SPACING + this.heightOffset\r\n                break\r\n\r\n            // left/right\r\n            case 1:\r\n                // Row full\r\n                if (this.spheres[cube.data.b][cube.data.r][incr==-1 ? this.span-1 : 0]) {\r\n                    return null\r\n                }\r\n\r\n                pos.c = incr==-1 ? 0 : this.span-1\r\n\r\n                while (this.spheres[cube.data.b][cube.data.r][pos.c]) {\r\n                    pos.c -= incr\r\n                }\r\n\r\n                pos.x = (pos.c - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n                break\r\n            // forward/backward\r\n            case 2:\r\n                // Row full\r\n                if (this.spheres[cube.data.b][incr==-1 ? this.span-1 : 0][cube.data.c]) {\r\n                    return null\r\n                }\r\n\r\n                pos.r = incr==-1 ? 0 : this.span-1\r\n\r\n                while (this.spheres[cube.data.b][pos.r][cube.data.c]) {\r\n                    pos.r -= incr\r\n                }\r\n\r\n                pos.z = (pos.r - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n                break\r\n        }\r\n\r\n        if (this.explodedMult!=1) {\r\n            pos.x *= this.explodedMult\r\n            pos.y *= this.explodedMult\r\n            pos.z *= this.explodedMult\r\n        }\r\n\r\n        // Don't render it if there's already a sphere at that location\r\n        if (this.spheres[pos.b][pos.r][pos.c]) {\r\n            return null\r\n        }\r\n\r\n        return pos\r\n    }\r\n\r\n    moveSphere (start, end, axis, location) {\r\n\r\n        // Set the new position for the sphere\r\n        const sphere = this.spheres[start.b][start.r][start.c]\r\n        sphere.isLerping = true\r\n        sphere.newPos = {}\r\n        sphere.newPos.axis = axis\r\n        sphere.newPos[axis] = (location - this.SPREAD) * this.BOX_WIDTH * this.SPACING\r\n\r\n        // Move the spheres in the spheres state\r\n        this.spheres[end.b][end.r][end.c] = sphere\r\n        this.spheres[start.b][start.r][start.c] = null\r\n    }\r\n\r\n    // Lerp the boxes into position, when exploded\r\n    lerpBoxes () {\r\n        if (this.isLerpingBoxes) {\r\n            for (let b=0; b<this.span; b++) {\r\n                for (let r=0; r<this.span; r++) {\r\n                    for (let c=0; c<this.span; c++) {\r\n\r\n                        if (b!=this.SPREAD && r!=this.SPREAD && c!=this.SPREAD\r\n                            && Math.abs(this.boxes[b][r][c].position.x - this.boxes[b][r][c].origPos.x * this.explodedMult) < 0.005) {\r\n\r\n                            this.isLerpingBoxes = false\r\n                            this.boxes[b][r][c].position.x = this.boxes[b][r][c].origPos.x * this.explodedMult\r\n                            this.boxes[b][r][c].position.y = this.boxes[b][r][c].origPos.y * this.explodedMult\r\n                            this.boxes[b][r][c].position.z = this.boxes[b][r][c].origPos.z * this.explodedMult\r\n\r\n                            if (this.spheres[b][r][c]) {\r\n                                this.spheres[b][r][c].position.x += this.spheres[b][r][c].origPos.x * this.explodedMult - this.spheres[b][r][c].position.x\r\n                                this.spheres[b][r][c].position.y += this.spheres[b][r][c].origPos.y * this.explodedMult - this.spheres[b][r][c].position.y\r\n                                this.spheres[b][r][c].position.z += this.spheres[b][r][c].origPos.z * this.explodedMult - this.spheres[b][r][c].position.z\r\n                            }\r\n\r\n                        } else {\r\n                            this.boxes[b][r][c].position.x += (this.boxes[b][r][c].origPos.x * this.explodedMult - this.boxes[b][r][c].position.x) / 10\r\n                            this.boxes[b][r][c].position.y += (this.boxes[b][r][c].origPos.y * this.explodedMult - this.boxes[b][r][c].position.y) / 10\r\n                            this.boxes[b][r][c].position.z += (this.boxes[b][r][c].origPos.z * this.explodedMult - this.boxes[b][r][c].position.z) / 10\r\n\r\n                            if (this.spheres[b][r][c]) {\r\n                                this.spheres[b][r][c].position.x += (this.spheres[b][r][c].origPos.x * this.explodedMult - this.spheres[b][r][c].position.x) / 10\r\n                                this.spheres[b][r][c].position.y += (this.spheres[b][r][c].origPos.y * this.explodedMult - this.spheres[b][r][c].position.y) / 10\r\n                                this.spheres[b][r][c].position.z += (this.spheres[b][r][c].origPos.z * this.explodedMult - this.spheres[b][r][c].position.z) / 10\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Lerp the spheres into their new place\r\n    lerpSpheres () {\r\n\r\n        this.someSphereIsLerping = false\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n\r\n                    if (this.spheres[b][r][c] && this.spheres[b][r][c].isLerping) {\r\n\r\n                        this.someSphereIsLerping = true\r\n\r\n                        const sphere = this.spheres[b][r][c]\r\n                        const {axis} = sphere.newPos\r\n\r\n                        if (Math.abs(sphere.position[axis] - sphere.newPos[axis] * this.explodedMult) > 0.01) {\r\n                            sphere.position[axis] += (sphere.newPos[axis] * this.explodedMult - sphere.position[axis]) / 10\r\n                        } else {\r\n                            sphere.isLerping = false\r\n                            sphere.position[axis] = sphere.newPos[axis] * this.explodedMult\r\n                            sphere.origPos[axis] = sphere.newPos[axis]\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    renderLoop () {\r\n\r\n        requestAnimationFrame(() => this.renderLoop())\r\n        this.lerpBoxes()\r\n        this.lerpSpheres()\r\n\r\n        this.camera.lookAt(this.scene.position)\r\n        this.camera.updateMatrixWorld()\r\n\r\n        this.renderer.render(this.scene, this.camera)\r\n        this.raycaster.setFromCamera(this.mouse, this.camera)\r\n\r\n        const intersects = this.raycaster.intersectObjects(this.scene.children, true)\r\n\r\n        if (intersects.length) {\r\n\r\n            // If still hovering on the same thing...\r\n            if (this.hoveredObject && (this.hoveredObject==intersects[0].object || this.hoveredObject==intersects[0].object.parent)) {\r\n\r\n                if (this.mouseIsDown && !this.hoveredObject.data.isClicked) {\r\n                    this.hoveredObject.data.isClicked = true\r\n                    setTimeout(() => {\r\n                        if (this.hoveredObject) {\r\n                            this.hoveredObject.data.isClicked = false\r\n                        }\r\n                    }, 500)\r\n\r\n                    const {b, r, c} = this.previewSphere.data\r\n\r\n                    if (this.game.gameState[b][r][c]===\" \") {\r\n                        if (ws){\r\n                            sendMove(this.game.playerIndex, b, r, c, this.game.gameState)\r\n                        } else {\r\n                            this.game.makeMove(this.game.playerIndex, b, r, c)\r\n                        }\r\n                    }\r\n                }\r\n\r\n            } else {\r\n\r\n                // Set the currently hovered over object\r\n                this.hoveredObject = intersects[0].object.data ? intersects[0].object : intersects[0].object.parent\r\n                this.clearHighlightedBoxes()\r\n\r\n                if (this.hoveredObject.data) {\r\n                    // Also TODO, decide which one of these to do, based on the current gravity\r\n\r\n                    if (!this.isLerpingBoxes && !this.someSphereIsLerping) {\r\n\r\n                        if (this.game.gravityEnabled) {\r\n                            switch (this.game.gravity.axis) {\r\n                                case 0:\r\n                                    this.highlightColumn(this.hoveredObject.data)\r\n                                    break\r\n                                case 1:\r\n                                    this.highlightRowY(this.hoveredObject.data)\r\n                                    break\r\n                                case 2:\r\n                                    this.highlightRowX(this.hoveredObject.data)\r\n                                    break\r\n                            }\r\n                        } else {\r\n                            // Highlight only the hovered over box\r\n                            const {b, r, c} = this.hoveredObject.data\r\n                            this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n                            this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n                            this.highlightedBoxes.push(this.boxes[b][r][c])\r\n                        }\r\n\r\n                        // Render the preview sphere at the correct location\r\n                        const pos = this.getPreviewPosition(this.hoveredObject)\r\n\r\n                        if (pos) {\r\n                            this.previewSphere.position.x = pos.x\r\n                            this.previewSphere.position.y = pos.y\r\n                            this.previewSphere.position.z = pos.z\r\n                            this.previewSphere.data = {\r\n                                b: pos.b,\r\n                                r: pos.r,\r\n                                c: pos.c\r\n                            }\r\n                            this.previewSphere.material.opacity = 0.5\r\n                        }\r\n                        // === ?\r\n                        // else {\r\n                        //     this.previewSphere.material.opacity = 0\r\n                        // }\r\n                    }\r\n                }\r\n            }\r\n\r\n        } else {\r\n\r\n            this.clearHighlightedBoxes()\r\n            this.previewSphere.material.opacity = 0\r\n\r\n            if (this.hoveredObject) {\r\n                if (this.hoveredObject.material) {\r\n                    this.hoveredObject.material.emissive.setHex(this.colours.LIGHTGREY)\r\n                    this.hoveredObject.material.opacity = this.OPACITY_OFF\r\n                    this.hoveredObject.data.isClicked = false\r\n                } else if (this.hoveredObject.parent) {\r\n                    this.hoveredObject.parent.material.emissive.setHex(this.colours.LIGHTGREY)\r\n                    this.hoveredObject.parent.material.opacity = this.OPACITY_OFF\r\n                    this.hoveredObject.parent.data.isClicked = false\r\n                }\r\n\r\n            }\r\n            this.hoveredObject = null\r\n        }\r\n    }\r\n\r\n    toggleExploded () {\r\n        this.explodedMult = this.explodedMult==1 ? 2 : 1\r\n        this.previewSphere.material.opacity = 0\r\n        this.isLerpingBoxes = true\r\n    }\r\n\r\n    addPoint (board, row, col, player, nextPlayer) {\r\n        this.addSphere(board, row, col, this.playerColours[player].toUpperCase())\r\n        this.previewSphere.material.opacity = 0\r\n\r\n        if (nextPlayer!==undefined) {\r\n            this.setPreviewColour(nextPlayer)\r\n        }\r\n    }\r\n\r\n    setPreviewColour (playerIndex) {\r\n        const previewColour = this.colours[this.playerColours[playerIndex].toUpperCase()]\r\n        this.previewSphere.material.color.setHex(previewColour)\r\n        this.previewSphere.material.emissive.setHex(previewColour)\r\n    }\r\n\r\n    highlightArrow (index) {\r\n        const arrowModel = arrowModels.filter(a => a.data.arrowIndex==index)\r\n\r\n        // Clear old arrow\r\n        if (clickedObject) {\r\n            clickedObject.children.forEach(c => c.material.emissive.setHex(this.colours.BRIGHTGREY))\r\n        }\r\n\r\n        // Set new one to cyan\r\n        arrowModel[0].children.forEach(c => c.material.emissive.setHex(this.colours.CYAN))\r\n        clickedObject = arrowModel[0]\r\n    }\r\n\r\n    render (gameState) {\r\n        this.resetBoard()\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (!Number.isNaN(parseInt(gameState[b][r][c]))) {\r\n                        this.addPoint(b, r, c, gameState[b][r][c])\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    resetBoard () {\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (this.spheres[b][r][c]) {\r\n                        this.scene.remove(this.spheres[b][r][c])\r\n                        this.spheres[b][r][c] = undefined\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    rotate () {\r\n        this.camera.position.x = Math.sin(this.rotation*Math.PI/180) * (this.BOX_WIDTH * 1.5) * this.span * 2\r\n        this.camera.position.z = Math.cos(this.rotation*Math.PI/180) * (this.BOX_WIDTH * 1.5) * this.span * 2\r\n    }\r\n\r\n}\r\n\r\ntypeof window!=\"undefined\" && (window.exports = window.exports || {})\r\n\"use strict\"\r\n\r\nclass GamePlayer {// eslint-disable-line\r\n\r\n    constructor (type, playerIndex, game) {\r\n\r\n        console.log(`new ${type} player: ${playerIndex}`)\r\n\r\n        this.type = type\r\n        this.game = game // Two way binding\r\n        this.playerIndex = playerIndex\r\n    }\r\n\r\n    clearLastState () {\r\n        for (let b=0; b<this.game.span; b++) {\r\n            for (let r=0; r<this.game.span; r++) {\r\n                for (let c=0; c<this.game.span; c++) {\r\n                    this.lastState[b][r][c] = \" \"\r\n                }\r\n            }\r\n        }\r\n        this.lastMove = undefined\r\n    }\r\n\r\n    pickMove (gameState) {\r\n\r\n        if (this.type != \"AI\") return\r\n\r\n        fetch(\"./getAIMove\", {\r\n            method: \"post\",\r\n            body: JSON.stringify({gameState})\r\n        })\r\n        .then(r => r.json())\r\n        .then(({move}) => {\r\n            const [b, r, c] = move\r\n            this.game.makeMove(this.playerIndex, b, r, c)\r\n        })\r\n    }\r\n\r\n    reward (value, gameState) {\r\n\r\n        if (this.type != \"AI\") return\r\n\r\n        fetch(\"./rewardAI\", {\r\n            method: \"post\",\r\n            body: JSON.stringify({value, gameState})\r\n        })\r\n    }\r\n\r\n}\r\n\r\ntypeof window!=\"undefined\" && (window.exports = window.exports || {})\r\ntypeof window!=\"undefined\" && (window.GamePlayer = GamePlayer)\r\nexports.GamePlayer = GamePlayer\r\n\"use strict\"\r\n\r\nclass GameLogic {// eslint-disable-line\r\n\r\n    constructor ({gameState, gameBoard, gravityEnabled=true, span=3, players=2, isTraining, isMultiplayer, aiOpponent, isVR}={}) {\r\n\r\n        this.players = []\r\n        this.gravityEnabled = gravityEnabled\r\n        this.span = parseInt(span)\r\n        this.numPlayers = parseInt(players)\r\n        this.isTraining = isTraining // AI\r\n        this.aiOpponent = aiOpponent // AI\r\n        this.isMultiplayer = isMultiplayer // TODO, will be used to disallow moves until a move is made via WebSocket\r\n\r\n        this.gameState = gameState || this.resetGame() // Allow accepting an existing game state to allow loading existing match\r\n        this.gravity = {\r\n            axis: 0, // 0 for up/down, 1 for left/right, 2 for  forward/backward\r\n            modifier: -1 // -1 for normal, 1 for reverse\r\n        }\r\n        this.directions = {\r\n            up: 0,\r\n            down: 0,\r\n            left: 1,\r\n            right: 1,\r\n            forward: 2,\r\n            backward: 2\r\n        }\r\n        this.modifiers = {\r\n            up: 1,\r\n            down: -1,\r\n            left: -1,\r\n            right: 1,\r\n            forward: -1,\r\n            backward: 1\r\n        }\r\n\r\n        // Randomize who starts\r\n        this.playerIndex = Math.floor(Math.random()*players)\r\n        this.board = new gameBoard(this, isVR)\r\n\r\n        // Set the first player to either AI or human (aka the actual player)\r\n        if (this.aiOpponent) {\r\n            this.players.push(new GamePlayer(\"AI\", 0, this))\r\n        } else {\r\n            this.players.push(new GamePlayer(\"local human\", 0))\r\n        }\r\n\r\n        // Set the rest to whatever was configured\r\n        for (let p=1; p<players; p++) {\r\n\r\n            // TODO, disallow more than 1 other player when playing against AI - model needed would be too big\r\n            if (this.isTraining) {\r\n                this.players.push(new GamePlayer(\"AI\", p, this))\r\n            } else if (isMultiplayer) {\r\n                this.players.push(new GamePlayer(\"remote human\", p))\r\n            } else {\r\n                this.players.push(new GamePlayer(\"local human\", p))\r\n            }\r\n        }\r\n\r\n        // playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        this.players[this.playerIndex].pickMove(this.gameState)\r\n    }\r\n\r\n    // Create the board brand new\r\n    resetGame () {\r\n\r\n        const gameState = []\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n\r\n            const boardGameState = []\r\n\r\n            for (let r=0; r<this.span; r++) {\r\n\r\n                const rowGameState = []\r\n\r\n                for (let c=0; c<this.span; c++) {\r\n                    rowGameState.push(\" \")\r\n                }\r\n\r\n                boardGameState.push(rowGameState)\r\n            }\r\n            gameState.push(boardGameState)\r\n        }\r\n\r\n        if (this.board) {\r\n            this.board.resetBoard()\r\n            // playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        }\r\n\r\n        // winsDisplay.style.display = \"none\"\r\n        this.gameState = gameState\r\n\r\n        // Clear the AI players' lastState\r\n        for (let p=0; p<this.players.length; p++) {\r\n            if (this.players[p].type == \"AI\") {\r\n                this.players[p].clearLastState()\r\n            }\r\n        }\r\n\r\n        return gameState\r\n    }\r\n\r\n    makeMove (p, b, r, c) {\r\n\r\n        if (p != this.playerIndex && !this.isTraining) {\r\n            console.log(\"NOT your turn!\")\r\n            return\r\n        }\r\n\r\n        // Illegal move\r\n        if (this.gameState[b][r][c] !== \" \") {\r\n            console.log(\"Illegal move\")\r\n\r\n            // Slap its hands, if it was an AI player\r\n            this.players[p].reward(-99, this.gameState)\r\n\r\n            // Stop the game if it's an AI, to avoid looping to stack overflow\r\n            if (this.players[p].type==\"AI\") {\r\n                this.resetGame()\r\n            }\r\n\r\n            return\r\n        }\r\n\r\n        [b, r, c] = this.applyGravityToMove(b, r, c)\r\n\r\n        this.gameState[b][r][c] = p\r\n        this.board.addPoint(b, r, c, p, (this.playerIndex+1) % this.players.length)\r\n\r\n        // Player wins\r\n        if (this.isWinningMove(b, r, c, p)) {\r\n            this.players[p].reward(1, this.gameState)\r\n            this.players.forEach((player, pi) => pi!=p && player.reward(-1, this.gameState))\r\n            // winsDisplay.style.display = \"inline-block\"\r\n            window.dispatchEvent(new CustomEvent(\"T^3Win\", {detail: p}))\r\n            return\r\n        }\r\n\r\n        // Tied game\r\n        if (this.isFull()) {\r\n            console.log(\"Tied game\")\r\n            this.players.forEach(player => player.reward(0.25, this.gameState))\r\n            window.dispatchEvent(new CustomEvent(\"T^3Tie\", {detail: p}))\r\n            return\r\n        }\r\n\r\n\r\n        // TODO, this might be useless - TEST\r\n        this.players.forEach((player, pi) => pi!=p && player.reward(0, this.gameState))\r\n\r\n        this.playerIndex = ++this.playerIndex % this.players.length\r\n\r\n        // TODO, do this outside of this class?\r\n        // playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        // winsDisplay.style.display = \"none\"\r\n\r\n        this.players[this.playerIndex].pickMove(this.gameState)\r\n        if (ws){\r\n            sendState(this.gameState)\r\n        }\r\n    }\r\n\r\n    isWinningMove (boardIndex, tileY, tileX, player) {\r\n\r\n        let match = false\r\n        const max = this.gameState[0].length-1\r\n        const mid = Math.floor(max/2)\r\n\r\n        // Check current board\r\n        match = this.gameState[boardIndex][tileY].every(col => col===player) // Horizontal\r\n            ||  this.gameState[boardIndex].every(row => row[tileX]===player) // Vertical\r\n            ||  (tileX + tileY)%2 === 0 && ( // Is it on a diagonal?\r\n                // Diagonal top-left -> bottom-right\r\n                this.gameState[boardIndex].every((row, ri) => row[ri]===player) ||\r\n                // Diagonal bottom-left -> top-right\r\n                this.gameState[boardIndex].every((row, ri) => row[max-ri]===player)\r\n            )\r\n\r\n        // Check other boards\r\n        // Up/Down\r\n        match = match || this.gameState.every(board => board[tileY][tileX] === player)\r\n\r\n        if (match) return true\r\n\r\n        // 3D diagonals\r\n        // Not in location unreachable by a diagonal\r\n        if (boardIndex !== mid || boardIndex===mid && (tileY===mid || tileX===mid)) {\r\n\r\n            match = match\r\n                ||  this.gameState.every((board, bi) => board[max-bi][tileX]===player) // Near-bottom -> Far-top\r\n                ||  this.gameState.every((board, bi) => board[bi][tileX]===player) // Far-bottom -> Near-top\r\n                ||  this.gameState.every((board, bi) => board[tileY][max-bi]===player) // Bottom-left -> Top-right\r\n                ||  this.gameState.every((board, bi) => board[tileY][bi]===player) // Bottom-right -> Top-left\r\n\r\n\r\n            if (match) return true\r\n\r\n            // Check cross diagonal (going from corners through the middle)\r\n            if (this.gameState[mid][mid][mid]===player) {\r\n\r\n                match = match\r\n                    ||  this.gameState.every((board, bi) => board[bi][bi]===player) // Far-bottom-left -> Near-top-right\r\n                    ||  this.gameState.every((board, bi) => board[max-bi][bi]===player) // Near-bottom-left -> Far-top-right\r\n                    ||  this.gameState.every((board, bi) => board[max-bi][max-bi]===player) // Near-bottom-right -> Far-top-left\r\n                    ||  this.gameState.every((board, bi) => board[bi][max-bi]===player) // Far-bottom-right -> Near-top-left\r\n            }\r\n        }\r\n\r\n        return match\r\n    }\r\n\r\n    isFull () {\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n                    if (this.gameState[b][r][c] === \" \") {\r\n                        return false\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    applyGravityToMove (board, row, col) {\r\n\r\n        if (!this.gravityEnabled) return [board, row, col]\r\n\r\n        let counts\r\n\r\n        switch (this.gravity.axis) {\r\n            // Up/Down\r\n            case 0:\r\n                counts = this.gravity.modifier==-1 ? board : this.span-1-board\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board + this.gravity.modifier][row][col]===\" \") {\r\n                        board += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n            // Left/Right\r\n            case 1:\r\n\r\n                counts = this.gravity.modifier==-1 ? col : this.span-1-col\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board][row][col + this.gravity.modifier]===\" \") {\r\n                        col += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n            // Forward/Backward\r\n            case 2:\r\n\r\n                counts = this.gravity.modifier==-1 ? row : this.span-1-row\r\n\r\n                for (let i=0; i<counts; i++) {\r\n                    if (this.gameState[board][row + this.gravity.modifier][col]===\" \") {\r\n                        row += this.gravity.modifier\r\n                    } else {\r\n                        break\r\n                    }\r\n                }\r\n                break\r\n        }\r\n\r\n        return [board, row, col]\r\n    }\r\n\r\n    /*\r\n        TODO, there's a bug where some points don't move as needed. I think this may be due\r\n        to the order in which the tiles are moved\r\n    */\r\n    shiftGravity (direction) {\r\n\r\n        this.gravity.axis = this.directions[direction]\r\n        this.gravity.modifier = this.modifiers[direction]\r\n\r\n        const max = Math.abs((this.gravity.modifier==-1 ? this.span-1 : 0)-(this.span-1))\r\n\r\n        switch (this.gravity.axis) {\r\n\r\n            // Up/Down (boards)\r\n            case 0:\r\n                // For every row\r\n                for (let r=0; r<this.span; r++) {\r\n                    // For every column\r\n                    for (let c=0; c<this.span; c++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyBoard:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[Math.abs(max-i)][r][c]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[Math.abs(max-i2)][r][c] !== \" \") {\r\n\r\n                                        this.board.moveSphere({b: Math.abs(max-i2), r, c}, {b: Math.abs(max-i), r, c}, \"y\", Math.abs(max-i))\r\n\r\n                                        this.gameState[Math.abs(max-i)][r][c] = this.gameState[Math.abs(max-i2)][r][c]\r\n                                        this.gameState[Math.abs(max-i2)][r][c] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyBoard\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                break\r\n\r\n            // Left/Right (columns)\r\n            case 1:\r\n\r\n                // For every board\r\n                for (let b=0; b<this.span; b++) {\r\n                    // For every row\r\n                    for (let r=0; r<this.span; r++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyColumn:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[b][r][Math.abs(max-i)]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[b][r][Math.abs(max-i2)]!==\" \") {\r\n\r\n                                        this.board.moveSphere({b, r, c: Math.abs(max-i2)}, {b, r, c: Math.abs(max-i)}, \"x\", Math.abs(max-i))\r\n\r\n                                        this.gameState[b][r][Math.abs(max-i)] = this.gameState[b][r][Math.abs(max-i2)]\r\n                                        this.gameState[b][r][Math.abs(max-i2)] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyColumn\r\n                            }\r\n\r\n                        }\r\n\r\n                    }\r\n                }\r\n                break\r\n\r\n            // Forward/Backward (rows)\r\n            case 2:\r\n\r\n                // For every board\r\n                for (let b=0; b<this.span; b++) {\r\n                    // For every row\r\n                    for (let r=0; r<this.span; r++) {\r\n\r\n                        let i2 = 0\r\n\r\n                        everyColumn:\r\n                        for (let i=0; i<this.span; i++) {\r\n\r\n                            if (this.gameState[b][Math.abs(max-i)][r]===\" \") {\r\n\r\n                                i2 = i+1\r\n\r\n                                while (i2<this.span) {\r\n                                    if (i2<this.span && i<this.span && this.gameState[b][Math.abs(max-i2)][r]!==\" \") {\r\n\r\n                                        this.board.moveSphere({b, r: Math.abs(max-i2), c: r}, {b, r: Math.abs(max-i), c: r}, \"z\", Math.abs(max-i))\r\n\r\n                                        this.gameState[b][Math.abs(max-i)][r] = this.gameState[b][Math.abs(max-i2)][r]\r\n                                        this.gameState[b][Math.abs(max-i2)][r] = \" \"\r\n\r\n                                        i += i2\r\n                                    }\r\n\r\n                                    i2++\r\n                                }\r\n                                break everyColumn\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                break\r\n        }\r\n\r\n        this.checkAll()\r\n\r\n        this.board.clearHighlightedBoxes()\r\n        this.board.setPreviewColour(this.playerIndex)\r\n    }\r\n\r\n\r\n    // Check the game status for all placed items (when the gravity is changed, and every item is potentially re-arranged)\r\n    // TODO, optimize this, as this is insanely inefficient\r\n    checkAll () {\r\n        let match = false\r\n        let player\r\n\r\n        for (let b=0; b<this.span; b++) {\r\n            for (let r=0; r<this.span; r++) {\r\n                for (let c=0; c<this.span; c++) {\r\n\r\n                    if (this.gameState[b][r][c] !== \" \") {\r\n                        match = match || this.isWinningMove(b, r, c, this.gameState[b][r][c])\r\n                        if (match) {\r\n                            player = this.gameState[b][r][c]\r\n                            break\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        return player\r\n\r\n\r\n        // if (match) {\r\n        //     playerNum.style.color = this.board.playerColours[player]\r\n        //     winsDisplay.style.display = \"inline-block\"\r\n        // } else {\r\n        //     this.playerIndex = ++this.playerIndex % this.players.length\r\n        //     winsDisplay.style.display = \"none\"\r\n        //     playerNum.style.color = this.board.playerColours[this.playerIndex]\r\n        // }\r\n    }\r\n\r\n}\r\n\r\ntypeof window!=\"undefined\" && (window.exports = window.exports || {})\r\ntypeof window!=\"undefined\" && (window.GameLogic = GameLogic)\r\nexports.GameLogic = GameLogic\r\n\"use strict\"\r\n\r\nclass VRGameBoard extends GameBoard {// eslint-disable-line\r\n\r\n    constructor (game) {\r\n        super(game, true)\r\n\r\n        this.arrowNames = [\"left\", \"right\", \"up\", \"down\", \"forward\", \"backward\"]\r\n        this.arrowModels = []\r\n    }\r\n\r\n    loadTHREEjsItems (items) {\r\n        this.scene = items.scene\r\n        this.camera = items.camera\r\n        this.raycaster = items.raycaster\r\n        this.mouse = items.mouse\r\n        this.renderer = items.renderer\r\n        this.boardElement = items.boardElement\r\n\r\n        this.heightOffset = 0.5\r\n        this.scene.add(this.previewSphere)\r\n\r\n        this.initBoards()\r\n        this.renderLoop()\r\n        this.rotate()\r\n\r\n        this.boardElement.addEventListener(\"mousemove\", event => {\r\n            const sizeY = event.target.height\r\n            const sizeX = event.target.width\r\n            this.mouse.x = event.offsetX / sizeX * 2 - 1\r\n            this.mouse.y = -event.offsetY / sizeY * 2 + 1\r\n        }, false)\r\n    }\r\n\r\n    // Add arrow models\r\n    makeArrows () {\r\n\r\n        const loader = new THREE.ObjectLoader()\r\n\r\n        // Don't re-draw them\r\n        if (!this.arrowModels.length) {\r\n            for (let a=0; a<6; a++) {\r\n                loader.load(\"lib/arrow.json\", model => {\r\n\r\n                    model.position.x = positions[a].x * 2 * Math.PI\r\n                    model.position.y = positions[a].y * 2 * Math.PI\r\n                    model.position.z = positions[a].z * 2 * Math.PI\r\n\r\n                    model.rotation.x = rotations[a].x * 2 * Math.PI\r\n                    model.rotation.y = rotations[a].y * 2 * Math.PI\r\n                    model.rotation.z = rotations[a].z * 2 * Math.PI\r\n\r\n                    model.children.forEach(c => {\r\n                        if (a==3) {\r\n                            c.material.emissive.setHex(this.colours.CYAN)\r\n                            this.clickedObject = model\r\n                        } else {\r\n                            c.material.emissive.setHex(this.colours.BRIGHTGREY)\r\n                        }\r\n                    })\r\n\r\n                    this.arrowModels.push(model)\r\n                    model.data = {arrowIndex: a}\r\n                    this.scene.add(model)\r\n                })\r\n            }\r\n        }\r\n    }\r\n\r\n    highlightArrow (index) {\r\n\r\n        const arrowModel = this.arrowModels.filter(a => a.data.arrowIndex==index)\r\n\r\n        // Clear old arrow\r\n        if (this.clickedObject) {\r\n            this.clickedObject.children.forEach(c => c.material.emissive.setHex(this.colours.BRIGHTGREY))\r\n        }\r\n\r\n        // Set new one to cyan\r\n        arrowModel[0].children.forEach(c => c.material.emissive.setHex(this.colours.CYAN))\r\n        this.clickedObject = arrowModel[0]\r\n    }\r\n\r\n    renderLoop () {\r\n\r\n        requestAnimationFrame(() => this.renderLoop())\r\n\r\n        this.lerpBoxes()\r\n        this.lerpSpheres()\r\n\r\n        const intersects = this.raycaster.intersectObjects(this.scene.children, true)\r\n\r\n        if (intersects.length) {\r\n\r\n            if (this.hoveredObject && this.hoveredObject.type==\"Scene\") {\r\n\r\n                document.body.style.cursor = \"pointer\"\r\n\r\n                if (this.hoveredObject == this.clickedObject) {\r\n                    // do nothing\r\n                } else {\r\n\r\n                    if (this.mouseIsDown) {\r\n\r\n                        this.highlightArrow(this.hoveredObject.data.arrowIndex)\r\n\r\n                        console.log(\"clicked\", this.arrowNames[this.clickedObject.data.arrowIndex])\r\n\r\n                        if (ws) {\r\n                            ws.send(JSON.stringify({\r\n                                direction: this.arrowNames[this.clickedObject.data.arrowIndex],\r\n                                userId: \"1234\",\r\n                                username: \"rob\",\r\n                                type: \"text\",\r\n                                room: roomNameValue,\r\n                                type: \"gravity\"\r\n                            }))\r\n                        } else {\r\n                            this.game.shiftGravity(this.arrowNames[this.clickedObject.data.arrowIndex])\r\n                        }\r\n\r\n                    } else {\r\n                        // Hovering over non clicked item without the mouse down\r\n                        this.arrowModels.forEach(arrow => {\r\n                            if (arrow != this.clickedObject) {\r\n                                arrow.children.forEach(c => c.material.emissive.setHex(this.colours.BRIGHTGREY))\r\n                            }\r\n                        })\r\n\r\n                        if (this.hoveredObject != this.clickedObject) {\r\n                            this.hoveredObject.children.forEach(c => c.material.emissive.setHex(this.colours.YELLOW))\r\n                        }\r\n                    }\r\n                }\r\n\r\n\r\n            } else {\r\n\r\n                // If still hovering on the same thing...\r\n                if (this.hoveredObject && (this.hoveredObject==intersects[0].object || this.hoveredObject==intersects[0].object.parent)) {\r\n\r\n\r\n                    if (this.mouseIsDown && !this.hoveredObject.data.isClicked) {\r\n                        this.hoveredObject.data.isClicked = true\r\n                        setTimeout(() => {\r\n                            if (this.hoveredObject) {\r\n                                this.hoveredObject.data.isClicked = false\r\n                            }\r\n                        }, 500)\r\n\r\n                        const {b, r, c} = this.previewSphere.data\r\n\r\n                        if (this.game.gameState[b][r][c]===\" \") {\r\n                            if (ws){\r\n                                sendMove(this.game.playerIndex, b, r, c, this.game.gameState)\r\n                            } else {\r\n                                this.game.makeMove(this.game.playerIndex, b, r, c)\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                } else {\r\n\r\n                    // Set the currently hovered over object\r\n                    this.hoveredObject = intersects[0].object.data ? intersects[0].object : intersects[0].object.parent\r\n                    this.clearHighlightedBoxes()\r\n\r\n                    if (this.hoveredObject.data && this.hoveredObject.type!=\"Scene\") {\r\n                        // Also TODO, decide which one of these to do, based on the current gravity\r\n\r\n                        if (!this.isLerpingBoxes && !this.someSphereIsLerping) {\r\n\r\n                            if (this.game.gravityEnabled) {\r\n                                if (this.hoveredObject.data) {\r\n                                    switch (this.game.gravity.axis) {\r\n                                        case 0:\r\n                                            this.highlightColumn(this.hoveredObject.data)\r\n                                            break\r\n                                        case 1:\r\n                                            this.highlightRowY(this.hoveredObject.data)\r\n                                            break\r\n                                        case 2:\r\n                                            this.highlightRowX(this.hoveredObject.data)\r\n                                            break\r\n                                    }\r\n                                }\r\n                            } else {\r\n                                // Highlight only the hovered over box\r\n                                const {b, r, c} = this.hoveredObject.data\r\n                                this.boxes[b][r][c].material.opacity = this.OPACITY_ON\r\n                                this.boxes[b][r][c].material.emissive.setHex(this.colours.DARKGREY)\r\n                                this.highlightedBoxes.push(this.boxes[b][r][c])\r\n                            }\r\n\r\n                            // Render the preview sphere at the correct location\r\n                            const pos = this.getPreviewPosition(this.hoveredObject)\r\n\r\n                            if (pos) {\r\n                                this.previewSphere.position.x = pos.x\r\n                                this.previewSphere.position.y = pos.y\r\n                                this.previewSphere.position.z = pos.z\r\n                                this.previewSphere.data = {\r\n                                    b: pos.b,\r\n                                    r: pos.r,\r\n                                    c: pos.c\r\n                                }\r\n                                this.previewSphere.material.opacity = 0.5\r\n                            }\r\n                            // === ?\r\n                            // else {\r\n                            //     this.previewSphere.material.opacity = 0\r\n                            // }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n        } else {\r\n\r\n            if (this.hoveredObject && this.hoveredObject.type==\"Scene\") {\r\n\r\n                document.body.style.cursor = \"default\"\r\n\r\n                if (this.arrowModels.length) {\r\n                    this.arrowModels.forEach(arrow => {\r\n\r\n                        if (arrow != this.clickedObject) {\r\n                            arrow.children.forEach(c => c.material.emissive.setHex(this.colours.BRIGHTGREY))\r\n                        }\r\n                    })\r\n                }\r\n\r\n            } else {\r\n\r\n                this.clearHighlightedBoxes()\r\n                this.previewSphere.material.opacity = 0\r\n\r\n                if (this.hoveredObject) {\r\n                    if (this.hoveredObject.material) {\r\n                        this.hoveredObject.material.emissive.setHex(this.colours.LIGHTGREY)\r\n                        this.hoveredObject.material.opacity = this.OPACITY_OFF\r\n                        this.hoveredObject.data.isClicked = false\r\n                    } else if (this.hoveredObject.parent && this.hoveredObject.parent.material) {\r\n                        this.hoveredObject.parent.material.emissive.setHex(this.colours.LIGHTGREY)\r\n                        this.hoveredObject.parent.material.opacity = this.OPACITY_OFF\r\n                        this.hoveredObject.parent.data.isClicked = false\r\n                    }\r\n\r\n                }\r\n            }\r\n\r\n\r\n            this.hoveredObject = null\r\n        }\r\n\r\n    }\r\n\r\n    rotate () {\r\n\r\n    }\r\n\r\n}\r\n\"use strict\"\r\n\r\nlet ws\r\nlet roomNameValue\r\n\r\nlet rotation = 45\r\n\r\nconst rotations = [\r\n    {x: 0.25, y: 0.0, z: 0}, // left\r\n    {x: 0.25, y: 0.50, z: 0}, // right\r\n    {x: 0.25, y: 0.75, z: 0}, // up\r\n    {x: 0.25, y: 0.25, z: 0}, // down\r\n    {x: 0.25, y: 0.50, z: 0.25}, // forward\r\n    {x: 0.25, y: 0.50, z: 0.75} // backward\r\n]\r\nconst positions = [\r\n    {x: -0.125, y: -0.4, z: 0}, // left\r\n    {x: 0.125, y: -0.4, z: 0}, // right\r\n    {x: 0, y: -0.3, z: 0}, // up\r\n    {x: 0, y: -0.5, z: 0}, // down\r\n    {x: 0, y: -0.4, z: -0.125}, // forward\r\n    {x: 0, y: -0.4, z: 0.125} // backward\r\n]\r\n\r\nwindow.getParameters = () => {\r\n\r\n    const parameters = {}\r\n\r\n    // Pull query parameters from url\r\n    const parametersString = location.search.substring(1)\r\n\r\n    if (parametersString.length) {\r\n        parametersString.split(\"&\").forEach(p => {\r\n            const [k,v] =  p.split(\"=\")\r\n            parameters[k] = v\r\n        })\r\n    }\r\n\r\n    return parameters\r\n}\r\n\r\n\r\nwindow.addEventListener(\"load\", () => {\r\n\r\n    // Prevent the device from going into sleep mode, to keep the screen turned on\r\n    screen.keepAwake = true\r\n\r\n    // Initialise THREEjs components, starting with the renderer\r\n    const renderer = new THREE.WebGLRenderer({antialias: true, alpha: true})\r\n    renderer.setPixelRatio(window.devicePixelRatio)\r\n    renderer.setSize(window.innerWidth, window.innerHeight)\r\n    document.body.appendChild(renderer.domElement)\r\n\r\n    renderer.domElement.addEventListener(\"click\", () => {\r\n        new NoSleep().enable()\r\n\r\n        if (!window.location.href.includes(\"localhost\")) {\r\n            document.fullscreenEnabled && renderer.domElement.requestFullScreen() ||\r\n            document.webkitFullscreenEnabled && renderer.domElement.webkitRequestFullScreen() ||\r\n            document.mozFullScreenEnabled && renderer.domElement.mozRequestFullScreen() ||\r\n            document.msFullScreenEnabled && renderer.domElement.msRequestFullScreen()\r\n        }\r\n    })\r\n\r\n    let effect = new THREE.VREffect(renderer)\r\n    effect.separation = 0\r\n    effect.setSize(window.innerWidth, window.innerHeight)\r\n\r\n    let vrDisplay\r\n    if (navigator.getVRDisplays) {\r\n        navigator.getVRDisplays().then(displays => displays.length && (vrDisplay = displays[0]))\r\n    }\r\n\r\n\r\n    // Button to enable VR mode\r\n    enterVRButton.addEventListener(\"click\", () => {\r\n        const controls = document.getElementById(\"controls\")\r\n\r\n        // Go back to non VR mode\r\n        if (enterVRButton.classList.contains(\"small\")) {\r\n            effect = new THREE.VREffect(renderer)\r\n            effect.separation = 0\r\n            effect.setSize(window.innerWidth, window.innerHeight)\r\n\r\n            enterVRButton.classList.remove(\"small\")\r\n            game.board.usingVR = false\r\n        } else {\r\n            // Start VR mode\r\n            if (navigator.userAgent.includes(\"Mobile VR\")) {\r\n                vrDisplay.requestPresent([{source: renderer.domElement}])\r\n            } else {\r\n                effect = new THREE.StereoEffect(renderer)\r\n                effect.separation = 0\r\n                effect.setSize(window.innerWidth, window.innerHeight)\r\n            }\r\n            game.board.usingVR = true\r\n\r\n            enterVRButton.classList.add(\"small\")\r\n        }\r\n    })\r\n\r\n    // Scenes and camera\r\n    const fov = 70\r\n    const scene = new THREE.Scene()\r\n    const camera = new THREE.PerspectiveCamera(fov, window.innerWidth / window.innerHeight, 1, 1000)\r\n    scene.add(camera)\r\n    camera.rotation.order = \"YXZ\"\r\n    camera.position.z = 4\r\n    camera.position.y = 2\r\n\r\n    // Controls\r\n    let controls = new THREE.OrbitControls(camera, renderer.domElement)\r\n    controls.target.set(\r\n        Math.cos(camera.position.x*Math.PI/180) * 4,\r\n        camera.position.y,\r\n        Math.sin(camera.position.z*Math.PI/180) * 4\r\n    )\r\n\r\n    // Set VR controls if available\r\n    const setOrientationControls = event => {\r\n\r\n        if (!event.alpha) return\r\n\r\n        controls = new THREE.VRControls(camera)\r\n        controls.update()\r\n\r\n        window.removeEventListener(\"deviceorientation\", setOrientationControls)\r\n    }\r\n    window.addEventListener(\"deviceorientation\", setOrientationControls)\r\n\r\n\r\n    // const loader = new THREE.ObjectLoader()\r\n    const raycaster = new THREE.Raycaster()\r\n    const mouse = new THREE.Vector2()\r\n    const light = new THREE.DirectionalLight( 0xffffff, 0.5 )\r\n    light.position.set( 0, 1, 0 ).normalize()\r\n    scene.add(light)\r\n\r\n    const resetGame = () => {\r\n\r\n        const {g, span, p} = getParameters()\r\n\r\n        window.game = new GameLogic({\r\n            gravityEnabled: !g || g==\"1\",\r\n            gameBoard: VRGameBoard,\r\n            span: parseInt(span) || 3,\r\n            players: parseInt(p) || 2,\r\n            isVR: true\r\n        })\r\n        game.board.loadTHREEjsItems({\r\n            scene: scene,\r\n            camera: camera,\r\n            raycaster: raycaster,\r\n            mouse: mouse,\r\n            renderer: renderer,\r\n            boardElement: renderer.domElement\r\n        })\r\n        game.board.makeArrows()\r\n    }\r\n    resetGame()\r\n\r\n    const render = () => {\r\n\r\n        requestAnimationFrame(render)\r\n        controls.update()\r\n\r\n        camera.lookAt(scene.position)\r\n        camera.updateMatrixWorld()\r\n        raycaster.setFromCamera(mouse, camera)\r\n\r\n        effect.render(scene, camera)\r\n\r\n    }\r\n    render()\r\n\r\n\r\n    const setRotation = rotation => {\r\n        camera.position.x = Math.cos(rotation*Math.PI/180) * 5\r\n        camera.position.z = Math.sin(rotation*Math.PI/180) * 5\r\n    }\r\n    setRotation(rotation=-45)\r\n\r\n    renderer.domElement.addEventListener(\"wheel\", ({deltaY}) => {\r\n        rotation = (rotation + (deltaY > 0 ? 1 : -1) * 5) % 360\r\n        setRotation(rotation)\r\n    })\r\n\r\n    document.addEventListener(\"mousedown\", event => {\r\n        game.board.mouseIsDown = true\r\n    })\r\n\r\n    document.addEventListener(\"mouseup\", () => {\r\n        game.board.mouseIsDown = false\r\n    })\r\n\r\n    document.addEventListener(\"click\", () => {\r\n        game.board.mouseIsDown = false\r\n    })\r\n\r\n    window.addEventListener(\"keydown\", e => {\r\n        if (e.code == \"Space\") {\r\n            game.board.toggleExploded()\r\n        }\r\n    })\r\n\r\n\r\n    /* MOTION CONTROLLER*/\r\n    let getVideoFeedAttempts = 0\r\n\r\n    const getVideoFeed = () => {\r\n        try {\r\n            if (\"mozGetUserMedia\" in navigator) {\r\n                navigator.mozGetUserMedia(\r\n                    {video: { facingMode: \"environment\" }},\r\n                    stream => {\r\n                        video.src = window.URL.createObjectURL(stream)\r\n                    },\r\n                    err => {\r\n                        console.log(err)\r\n                        alert(\"There was an error accessing the camera. Please try again and ensure you are using https\")\r\n                    }\r\n                )\r\n            } else {\r\n                const mediaDevicesSupport = navigator.mediaDevices && navigator.mediaDevices.getUserMedia\r\n\r\n                if (mediaDevicesSupport) {\r\n                    navigator.mediaDevices\r\n                    .getUserMedia({ video: { facingMode: \"environment\" } })\r\n                    .then(stream => {\r\n                        video.src = window.URL.createObjectURL(stream)\r\n                    })\r\n                    .catch(err => {\r\n                        console.log(err)\r\n                        getVideoFeedAttempts++\r\n\r\n                        // Sometimes, getting the camera can fail. Re-attempting usually works, on refresh. This simulates that.\r\n                        if (getVideoFeedAttempts<3) {\r\n                            getVideoFeed()\r\n                        } else {\r\n                            alert(\"There was an error accessing the camera. Please try again and ensure you are using https\")\r\n                        }\r\n                    })\r\n                } else {\r\n                    const getUserMedia =\r\n                        navigator.getUserMedia ||\r\n                        navigator.webkitGetUserMedia ||\r\n                        navigator.mozGetUserMedia ||\r\n                        navigator.msGetUserMedia\r\n\r\n                    if (getUserMedia) {\r\n                        getUserMedia(\r\n                            { video: { facingMode: \"environment\" } },\r\n                            stream => {\r\n                                video.src = window.URL.createObjectURL(stream)\r\n                            },\r\n                            err => {\r\n                                console.log(err)\r\n                                alert(\"There was an error accessing the camera. Please try again and ensure you are using https.\")\r\n                            }\r\n                        )\r\n                    } else {\r\n                        alert(\"Camera not available\")\r\n                    }\r\n                }\r\n            }\r\n\r\n        } catch (e) {\r\n            alert(\"Error getting camera feed. Please ensure you are using https.\")\r\n        }\r\n    }\r\n\r\n    window.video = document.createElement(\"video\")\r\n    video.autoplay = true\r\n    video.width = window.innerWidth\r\n    video.height = window.innerHeight / 2\r\n    getVideoFeed()\r\n\r\n    const buffer = document.createElement(\"canvas\")\r\n    buffer.width = video.width\r\n    buffer.height = video.height\r\n    const bufferC = buffer.getContext(\"2d\")\r\n\r\n    let lastX = 0\r\n    let lastY = 0\r\n\r\n    let newX = 0\r\n    let newY = 0\r\n\r\n    const bounds = 100\r\n    let foundWithinBounds = false\r\n\r\n    let frameCounter = -1\r\n\r\n    const moveCursor = (x, y) => {\r\n\r\n        // console.log(x, y)\r\n        tempCursor.style.marginTop = parseInt(y/video.height * window.innerHeight)+\"px\"\r\n        let leftM = parseInt(x/video.width * window.innerWidth)\r\n\r\n        if (game.board.usingVR) {\r\n            leftM = leftM / 2\r\n        }\r\n\r\n        tempCursor.style.marginLeft = leftM+\"px\"\r\n\r\n        game.board.mouse.x = x / video.width * 2 - 1\r\n        game.board.mouse.y = (y / video.height * 2 - 1) * -1\r\n    }\r\n\r\n    window.readCircle = () => {\r\n\r\n        requestAnimationFrame(readCircle)\r\n\r\n        // Only read a new position every 10 frames\r\n        if (++frameCounter%5==0) {\r\n\r\n            bufferC.drawImage(video, 0, 0, video.width, video.height)\r\n            const data = bufferC.getImageData(0, 0, video.width, video.height).data\r\n\r\n            let avgX = 0\r\n            let avgY = 0\r\n            let counter = 0\r\n\r\n            let startR = 0\r\n            let startC = 0\r\n            let endR = video.height\r\n            let endC = video.width\r\n\r\n            // Limit the search area when the position can be roughly estimated from the previous frame\r\n            if (foundWithinBounds) {\r\n                startR = parseInt(Math.max(lastY - bounds, 0))\r\n                startC = parseInt(Math.max(lastX - bounds, 0))\r\n                endR = parseInt(Math.min(lastY + bounds, video.width))\r\n                endC = parseInt(Math.min(lastX + bounds, video.height))\r\n            }\r\n\r\n            // For every 4th row\r\n            for (let r=startR; r<endR; r+=4) {\r\n                // For every 4th column\r\n                for (let c=startC; c<endC; c+=4) {\r\n\r\n                    // Pixel coords\r\n                    const p = r*video.width + c\r\n                    const pixel = [data[p*4]/255, data[p*4+1]/255, data[p*4+2]/255]\r\n\r\n                    if (pixel[0]<=0.75 && pixel[1] >= 0.75 && pixel[2]<=0.7) {\r\n                        counter++\r\n                        avgX += c\r\n                        avgY += r\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (counter>10) {\r\n                newX = avgX / counter\r\n                newY = avgY / counter\r\n                foundWithinBounds = true\r\n            } else {\r\n                foundWithinBounds = false\r\n            }\r\n        }\r\n\r\n        lastX += (newX-lastX)/20\r\n        lastY += (newY-lastY)/20\r\n\r\n        moveCursor(lastX, lastY)\r\n    }\r\n\r\n})\n//# sourceMappingURL=scriptVR.concat.js.map"]}